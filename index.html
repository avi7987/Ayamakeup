<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartBeauty CRM Ultimate V14 - Full Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800;900&display=swap');
        
        :root {
            --primary: #9333ea;
            --primary-light: #f3e8ff;
            --secondary: #db2777;
            --bg-soft: #fdf2f8;
            --glass: rgba(255, 255, 255, 0.8);
        }

        body { 
            font-family: 'Heebo', sans-serif; 
            background-color: var(--bg-soft); 
            margin: 0; 
            color: #1f2937;
            display: flex;
            flex-direction: column;
            align-items: center; /* ××¨×›×•×– ×”××¤×œ×™×§×¦×™×” */
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- ×§×•× ×˜×™×™× ×¨ ××¨×›×–×™ ×§×©×™×— ×œ××¨×›×•×– --- */
        .app-container {
            width: 100%;
            max-width: 1400px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 100%;
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- × ×™×•×•×˜ --- */
        .nav-btn {
            padding: 12px 24px;
            border-radius: 16px;
            font-weight: 800;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary-light);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            box-shadow: 0 10px 15px -3px rgba(147, 51, 234, 0.3);
            transform: translateY(-2px);
        }

        /* --- ×œ×•×— ×§× ×‘×Ÿ ××©×•×¤×¨ --- */
        .kanban-wrapper {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            width: 100%;
            margin-top: 25px;
            height: calc(100vh - 220px);
            min-height: 600px;
        }

        @media (max-width: 1100px) { .kanban-wrapper { grid-template-columns: repeat(3, 1fr); height: auto; } }
        @media (max-width: 650px) { .kanban-wrapper { grid-template-columns: repeat(2, 1fr); } }

        .kanban-col {
            background: rgba(243, 232, 255, 0.4);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(147, 51, 234, 0.1);
            backdrop-filter: blur(10px);
            max-height: 100%;
        }

        .kanban-col h3 {
            background: white;
            padding: 15px;
            font-weight: 900;
            text-align: center;
            color: var(--primary);
            border-bottom: 3px solid var(--bg-soft);
            border-radius: 20px 20px 0 0;
        }

        .kanban-list {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            min-height: 150px;
        }

        .lead-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border-right: 5px solid var(--primary);
            transition: all 0.2s;
            cursor: grab;
            position: relative;
        }

        .lead-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.05); }

        /* --- ×˜×¤×¡×™× ×•××•×“×œ×™× --- */
        .glass-card {
            background: white;
            border-radius: 30px;
            padding: 35px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.5);
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 2px solid #f3e8ff;
            border-radius: 16px;
            outline: none;
            transition: all 0.2s;
            font-weight: 500;
        }

        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(147,51,234,0.1); }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* --- ×›×¤×ª×•×¨ ×¡× ×›×¨×•×Ÿ ×¦×£ --- */
        #sync-indicator {
            position: fixed;
            bottom: 25px;
            left: 25px;
            padding: 10px 20px;
            background: white;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 700;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            z-index: 200;
        }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #10b981; }
        .status-dot.syncing { background: #f59e0b; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-l from-purple-600 to-pink-600">SmartBeauty CRM</h1>
            <div class="flex gap-2">
                <button onclick="switchTab('entry')" id="tab-entry" class="nav-btn active">ğŸ’° ×”×›× ×¡×”</button>
                <button onclick="switchTab('leads')" id="tab-leads" class="nav-btn">ğŸ¯ ×œ×™×“×™×</button>
                <button onclick="switchTab('manage')" id="tab-manage" class="nav-btn">âš™ï¸ × ×™×”×•×œ</button>
                <button onclick="switchTab('stats')" id="tab-stats" class="nav-btn">ğŸ“Š ×’×¨×¤×™×</button>
            </div>
        </div>
    </header>

    <div class="app-container">
        
        <section id="view-entry" class="w-full max-w-xl mt-10">
            <div class="glass-card text-right">
                <h2 class="text-2xl font-black mb-8 text-center text-gray-800">×¨×™×©×•× ×¢×¡×§×” ×—×“×©×”</h2>
                <div class="space-y-2">
                    <label class="text-sm font-bold text-gray-400 mr-2">×©× ×”×œ×§×•×—×”</label>
                    <input type="text" id="inc-name" placeholder="×©× ××œ×">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-bold text-gray-400 mr-2">×¡×›×•×</label>
                            <input type="number" id="inc-amount" placeholder="0.00 â‚ª">
                        </div>
                        <div>
                            <label class="text-sm font-bold text-gray-400 mr-2">×ª××¨×™×š</label>
                            <input type="date" id="inc-date">
                        </div>
                    </div>

                    <label class="text-sm font-bold text-gray-400 mr-2">×¡×•×’ ×”×©×™×¨×•×ª</label>
                    <input type="text" id="inc-service" placeholder="×œ××©×œ: ××™×¤×•×¨ + ×©×™×¢×¨">

                    <label class="text-sm font-bold text-gray-400 mr-2">×©×™×˜×ª ×ª×©×œ×•×</label>
                    <select id="inc-method">
                        <option value="××–×•××Ÿ">××–×•××Ÿ</option>
                        <option value="×‘×™×˜/×¤×™×™×‘×•×§×¡">×‘×™×˜ / ×¤×™×™×‘×•×§×¡</option>
                        <option value="××©×¨××™">××©×¨××™</option>
                        <option value="×”×¢×‘×¨×”">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                    </select>

                    <label class="flex items-center gap-4 p-5 bg-purple-50 rounded-2xl cursor-pointer hover:bg-purple-100 transition mt-4">
                        <input type="checkbox" id="inc-bride" class="w-6 h-6 accent-purple-600">
                        <span class="font-black text-purple-800 text-lg">×¢×¡×§×ª ×›×œ×”? ğŸ‘°</span>
                    </label>

                    <button onclick="handleIncomeSubmit()" id="save-btn" class="w-full mt-8 bg-gradient-to-r from-purple-600 to-purple-800 text-white py-5 rounded-2xl font-black text-xl shadow-xl hover:scale-[1.02] transition-all">
                        ×©××•×¨ ×•×¡× ×›×¨×Ÿ ×œ×¢× ×Ÿ
                    </button>
                </div>
            </div>
        </section>

        <section id="view-leads" class="hidden w-full">
            <div class="flex justify-between items-center mb-6">
                <button onclick="openModal('lead-modal')" class="bg-purple-600 text-white px-8 py-3 rounded-2xl font-black shadow-lg hover:bg-purple-700 transition">+ ×”×•×¡×¤×ª ×œ×™×“</button>
                <div class="text-right">
                    <h2 class="text-3xl font-black text-purple-900 leading-none">×¦× ×¨×ª ×œ×§×•×—×•×ª</h2>
                    <p class="text-gray-500 font-bold mt-1">×’×¨×¨×™ ×›×¨×˜×™×¡×™×•×ª ×œ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡</p>
                </div>
            </div>
            <div class="kanban-wrapper" id="kanban-board"></div>
        </section>

        <section id="view-manage" class="hidden w-full">
            <div class="bg-white rounded-[30px] shadow-xl overflow-hidden">
                <div class="p-6 bg-gray-50 border-b flex justify-between items-center">
                    <input type="text" id="table-search" oninput="filterTable()" class="!w-64 !mb-0" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×...">
                    <h2 class="text-xl font-black">×™×•××Ÿ ×¢×¡×§××•×ª ××¤×•×¨×˜</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-purple-50 text-purple-900">
                            <tr>
                                <th class="p-4 font-black">×ª××¨×™×š</th>
                                <th class="p-4 font-black">×œ×§×•×—×”</th>
                                <th class="p-4 font-black">×¡×›×•×</th>
                                <th class="p-4 font-black">×©×™×¨×•×ª</th>
                                <th class="p-4 font-black">×©×™×˜×”</th>
                                <th class="p-4 font-black">×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="manage-table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="view-stats" class="hidden w-full">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                <div class="glass-card text-center !p-6 border-b-8 border-purple-500">
                    <p class="text-gray-400 font-bold">×”×›× ×¡×” ×—×•×“×©×™×ª</p>
                    <h3 id="stat-total" class="text-4xl font-black text-purple-700">â‚ª0</h3>
                </div>
                <div class="glass-card text-center !p-6 border-b-8 border-pink-500">
                    <p class="text-gray-400 font-bold">×›×œ×•×ª ×”×—×•×“×©</p>
                    <h3 id="stat-brides" class="text-4xl font-black text-pink-600">0</h3>
                </div>
                <div class="glass-card text-center !p-6 border-b-8 border-blue-500">
                    <p class="text-gray-400 font-bold">×××•×¦×¢ ×œ×¢×¡×§×”</p>
                    <h3 id="stat-avg" class="text-4xl font-black text-blue-600">â‚ª0</h3>
                </div>
                <div class="glass-card text-center !p-6 border-b-8 border-green-500">
                    <p class="text-gray-400 font-bold">×¡×”"×› ×¢×¡×§××•×ª</p>
                    <h3 id="stat-count" class="text-4xl font-black text-green-600">0</h3>
                </div>
            </div>
            <div class="glass-card h-[450px]">
                <canvas id="mainChart"></canvas>
            </div>
        </section>
    </div>

    <div id="lead-modal" class="modal">
        <div class="glass-card w-full max-w-md text-right">
            <h3 class="text-2xl font-black mb-6 text-center">×œ×™×“ ×—×“×© ×‘××¢×¨×›×ª</h3>
            <input type="text" id="l-name" placeholder="×©× ×”×œ×§×•×—×” *">
            <input type="tel" id="l-phone" placeholder="×˜×œ×¤×•×Ÿ">
            <select id="l-source">
                <option value="××™× ×¡×˜×’×¨×">××™× ×¡×˜×’×¨×</option>
                <option value="×¤×™×™×¡×‘×•×§">×¤×™×™×¡×‘×•×§</option>
                <option value="×˜×™×§×˜×•×§">×˜×™×§×˜×•×§</option>
                <option value="×”××œ×¦×”">×”××œ×¦×”</option>
                <option value="××—×¨">××—×¨</option>
            </select>
            <textarea id="l-note" placeholder="×”×¢×¨×•×ª ×œ×’×‘×™ ×”×œ×™×“..."></textarea>
            <div class="flex gap-4 mt-4">
                <button onclick="handleLeadSubmit()" class="flex-1 bg-purple-600 text-white py-4 rounded-xl font-black shadow-lg">×©××•×¨ ×œ×™×“</button>
                <button onclick="closeModal('lead-modal')" class="flex-1 bg-gray-100 py-4 rounded-xl font-black">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div id="sync-indicator">
        <div id="sync-dot" class="status-dot"></div>
        <span id="sync-text">××¡×•× ×›×¨×Ÿ ×œ×¢× ×Ÿ</span>
    </div>

    <script>
        /**
         * LOGIC SYSTEM V14 - THE "BRAIN"
         */
        
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbydwcb9Elv-S-xFhySVkioiaJrLPwx7I9LxzSLY6ep_aR22ErmKBEuAUG_ZPp0u1JghHw/exec'; 
        
        let state = {
            incomes: JSON.parse(localStorage.getItem('crm_inc_v14')) || [],
            leads: JSON.parse(localStorage.getItem('crm_leads_v14')) || [],
            chart: null,
            activeTab: 'entry'
        };

        const STAGES = [
            {id: 'new', label: '×¤× ×™×™×” ×—×“×©×”'},
            {id: 'contact', label: '× ×•×¦×¨ ×§×©×¨'},
            {id: 'meeting', label: '× ×§×‘×¢ ×™×™×¢×•×¥'},
            {id: 'offer', label: '×”×¦×¢×ª ××—×™×¨'},
            {id: 'closed', label: '×¡×’×™×¨×” ××•×¦×œ×—×ª'},
            {id: 'archive', label: '××¨×›×™×•×Ÿ'}
        ];

        const MONTHS = ["×™× ×•××¨", "×¤×‘×¨×•××¨", "××¨×¥", "××¤×¨×™×œ", "×××™", "×™×•× ×™", "×™×•×œ×™", "××•×’×•×¡×˜", "×¡×¤×˜××‘×¨", "××•×§×˜×•×‘×¨", "× ×•×‘××‘×¨", "×“×¦××‘×¨"];

        // --- ××ª×—×•×œ ---
        window.onload = async () => {
            document.getElementById('inc-date').valueAsDate = new Date();
            renderKanban();
            renderManageTable();
            refreshStats();
            await fetchAllFromCloud(); // ×¡× ×›×¨×•×Ÿ ×›×¤×•×œ ×‘×˜×¢×™× ×”
        };

        // --- ×¡× ×›×¨×•×Ÿ ×¢× ×Ÿ (GET & POST) ---
        async function fetchAllFromCloud() {
            setSyncStatus(true, "××•×©×š × ×ª×•× ×™×...");
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getData`);
                const data = await response.json();
                if(data) {
                    state.incomes = data.incomes || [];
                    state.leads = data.leads || [];
                    saveLocal();
                    renderAll();
                    setSyncStatus(false, "×¡×•× ×›×¨×Ÿ ×‘×”×¦×œ×—×” âœ…");
                }
            } catch (e) {
                setSyncStatus(false, "××¦×‘ ××•×¤×œ×™×™×Ÿ ğŸ“¶", true);
            }
        }

        async function postToCloud(payload) {
            setSyncStatus(true, "××¢×“×›×Ÿ ×¢× ×Ÿ...");
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                setSyncStatus(false, "×¡×•× ×›×¨×Ÿ ×‘×”×¦×œ×—×” âœ…");
            } catch (e) {
                setSyncStatus(false, "×©××¨ ××§×•××™×ª ×‘×œ×‘×“ âš ï¸", true);
            }
        }

        // --- × ×™×”×•×œ ×”×›× ×¡×•×ª ---
        async function handleIncomeSubmit() {
            const data = {
                action: 'addIncome',
                id: Date.now(),
                name: document.getElementById('inc-name').value.trim(),
                amount: parseFloat(document.getElementById('inc-amount').value),
                service: document.getElementById('inc-service').value,
                date: document.getElementById('inc-date').value,
                method: document.getElementById('inc-method').value,
                isBride: document.getElementById('inc-bride').checked,
                month: MONTHS[new Date(document.getElementById('inc-date').value).getMonth()]
            };

            if(!data.name || isNaN(data.amount)) return alert("×× × ××œ× ×©× ×•×¡×›×•× ×ª×§×™×Ÿ");

            state.incomes.push(data);
            saveLocal();
            renderAll();
            
            // ××™×¤×•×¡ ×©×“×•×ª
            document.getElementById('inc-name').value = '';
            document.getElementById('inc-amount').value = '';
            
            await postToCloud(data);
        }

        async function deleteIncome(id) {
            if(!confirm("×œ××—×•×§ ×œ×¦××™×ª×•×ª?")) return;
            state.incomes = state.incomes.filter(i => i.id !== id);
            saveLocal();
            renderAll();
            await postToCloud({ action: 'deleteIncome', id: id });
        }

        // --- × ×™×”×•×œ ×œ×™×“×™× (×§× ×‘×Ÿ) ---
        function renderKanban() {
            const board = document.getElementById('kanban-board');
            if(!board) return;
            
            board.innerHTML = STAGES.map(stage => `
                <div class="kanban-col">
                    <h3>${stage.label}</h3>
                    <div class="kanban-list" id="list-${stage.id}" data-stage="${stage.id}">
                        ${state.leads.filter(l => l.status === stage.id).map(l => `
                            <div class="lead-card" data-id="${l.id}">
                                <div class="font-black text-gray-800">${l.name}</div>
                                <div class="text-xs text-gray-500 mt-1">${l.phone || ''}</div>
                                <div class="flex justify-between items-center mt-3 border-t pt-2">
                                    <span class="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-bold">${l.source}</span>
                                    <button onclick="deleteLead(${l.id})" class="text-gray-300 hover:text-red-500">ğŸ—‘</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            STAGES.forEach(stage => {
                new Sortable(document.getElementById(`list-${stage.id}`), {
                    group: 'leads',
                    animation: 150,
                    ghostClass: 'opacity-50',
                    onEnd: async (evt) => {
                        const id = evt.item.dataset.id;
                        const status = evt.to.dataset.stage;
                        const lead = state.leads.find(l => l.id == id);
                        if(lead) {
                            lead.status = status;
                            saveLocal();
                            await postToCloud({ action: 'updateLeadStatus', id, status });
                        }
                    }
                });
            });
        }

        async function handleLeadSubmit() {
            const data = {
                action: 'addLead',
                id: Date.now(),
                name: document.getElementById('l-name').value.trim(),
                phone: document.getElementById('l-phone').value,
                source: document.getElementById('l-source').value,
                note: document.getElementById('l-note').value,
                status: 'new'
            };
            if(!data.name) return alert("×©× ×”×•× ×—×•×‘×”");
            
            state.leads.push(data);
            saveLocal();
            renderKanban();
            closeModal('lead-modal');
            await postToCloud(data);
        }

        async function deleteLead(id) {
            if(!confirm("×œ××—×•×§ ×œ×™×“?")) return;
            state.leads = state.leads.filter(l => l.id !== id);
            saveLocal();
            renderKanban();
            await postToCloud({ action: 'deleteLead', id });
        }

        // --- ×˜×‘×œ×” ×•×—×™×¤×•×© ---
        function renderManageTable() {
            const tbody = document.getElementById('manage-table-body');
            const search = document.getElementById('table-search')?.value.toLowerCase() || '';
            
            const filtered = state.incomes.filter(inc => inc.name.toLowerCase().includes(search));
            
            tbody.innerHTML = filtered.sort((a,b) => new Date(b.date) - new Date(a.date)).map(inc => `
                <tr class="hover:bg-purple-50 transition">
                    <td class="p-4 text-sm">${new Date(inc.date).toLocaleDateString('he-IL')}</td>
                    <td class="p-4 font-bold text-gray-800">${inc.name} ${inc.isBride ? 'ğŸ‘°' : ''}</td>
                    <td class="p-4 font-black text-purple-600">â‚ª${inc.amount.toLocaleString()}</td>
                    <td class="p-4 text-sm">${inc.service || '-'}</td>
                    <td class="p-4 text-xs font-bold text-gray-400">${inc.method || '-'}</td>
                    <td class="p-4">
                        <button onclick="deleteIncome(${inc.id})" class="text-red-400 hover:text-red-600 font-bold">××—×§</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterTable() { renderManageTable(); }

        // --- ×¡×˜×˜×™×¡×˜×™×§×” ×•×’×¨×¤×™× ---
        function refreshStats() {
            const now = new Date();
            const thisMonth = MONTHS[now.getMonth()];
            const monthly = state.incomes.filter(i => i.month === thisMonth);
            
            const total = monthly.reduce((s, i) => s + i.amount, 0);
            const brides = monthly.filter(i => i.isBride).length;
            const avg = monthly.length ? (total / monthly.length) : 0;

            document.getElementById('stat-total').innerText = 'â‚ª' + total.toLocaleString();
            document.getElementById('stat-brides').innerText = brides;
            document.getElementById('stat-avg').innerText = 'â‚ª' + Math.round(avg).toLocaleString();
            document.getElementById('stat-count').innerText = monthly.length;

            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const monthlySums = MONTHS.map(m => 
                state.incomes.filter(i => i.month === m).reduce((s, i) => s + i.amount, 0)
            );

            if(state.chart) state.chart.destroy();
            state.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: MONTHS,
                    datasets: [{
                        label: '×”×›× ×¡×•×ª â‚ª',
                        data: monthlySums,
                        backgroundColor: '#9333ea',
                        borderRadius: 12,
                        hoverBackgroundColor: '#db2777'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×ª×©×ª×™×ª ---
        function switchTab(t) {
            ['entry', 'leads', 'manage', 'stats'].forEach(id => {
                document.getElementById('view-'+id).classList.add('hidden');
                document.getElementById('tab-'+id).classList.remove('active');
            });
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('tab-'+t).classList.add('active');
            
            if(t === 'leads') renderKanban();
            if(t === 'manage') renderManageTable();
            if(t === 'stats') refreshStats();
        }

        function renderAll() {
            renderKanban();
            renderManageTable();
            refreshStats();
        }

        function saveLocal() {
            localStorage.setItem('crm_inc_v14', JSON.stringify(state.incomes));
            localStorage.setItem('crm_leads_v14', JSON.stringify(state.leads));
        }

        function setSyncStatus(isSyncing, text, isError = false) {
            const dot = document.getElementById('sync-dot');
            const txt = document.getElementById('sync-text');
            txt.innerText = text;
            if(isSyncing) {
                dot.classList.add('syncing');
            } else {
                dot.classList.remove('syncing');
                dot.style.background = isError ? '#ef4444' : '#10b981';
            }
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>

