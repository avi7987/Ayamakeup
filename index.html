<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Pro V10 - Full Logic System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800&display=swap');
        
        :root {
            --primary: #9333ea;
            --secondary: #db2777;
            --bg-soft: #fdf2f8;
        }

        body { 
            font-family: 'Heebo', sans-serif; 
            background-color: var(--bg-soft); 
            margin: 0; 
            color: #1f2937;
            touch-action: manipulation;
        }

        /* ××¢×¨×›×ª ×”-Grid ×œ-6 ×¢××•×“×•×ª ×œ×œ× ×’×œ×™×œ×” */
        .kanban-wrapper {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            width: 100%;
            padding: 8px;
            height: calc(100vh - 180px);
            min-height: 500px;
        }

        @media (max-width: 768px) {
            .kanban-wrapper { gap: 3px; padding: 4px; }
            .kanban-col h3 { font-size: 0.6rem !important; }
            .lead-card { padding: 4px !important; }
            .lead-card .name { font-size: 0.7rem !important; }
            .lead-card .tags { display: none; }
        }

        .kanban-col {
            background: rgba(243, 232, 255, 0.6);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(147, 51, 234, 0.1);
            overflow: hidden;
        }

        .kanban-col h3 {
            background: white;
            padding: 8px 4px;
            font-size: 0.85rem;
            font-weight: 800;
            text-align: center;
            color: var(--primary);
            border-bottom: 2px solid var(--bg-soft);
        }

        .kanban-list {
            flex: 1;
            padding: 6px;
            overflow-y: auto;
            min-height: 100px;
        }

        .lead-card {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border-right: 4px solid var(--primary);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab;
        }

        .lead-card:active { cursor: grabbing; transform: scale(0.98); }

        /* ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ××¢×•×¦×‘×™× */
        .nav-btn {
            padding: 12px 24px;
            border-radius: 16px;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            color: var(--primary);
            border: 2px solid #f3e8ff;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 24px;
            padding: 24px;
            max-height: 90vh;
            overflow-y: auto;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid #f3e8ff;
            border-radius: 12px;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus { border-color: var(--primary); }

        .hidden { display: none; }
    </style>
</head>
<body>

    <header class="p-4 bg-white shadow-sm mb-4">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-l from-purple-600 to-pink-600">SmartBeauty CRM</h1>
            <div class="flex gap-2">
                <button onclick="switchTab('entry')" id="tab-entry" class="nav-btn active">ğŸ’° ×”×›× ×¡×”</button>
                <button onclick="switchTab('leads')" id="tab-leads" class="nav-btn">ğŸ¯ ×œ×™×“×™×</button>
                <button onclick="switchTab('stats')" id="tab-stats" class="nav-btn">ğŸ“Š × ×™×”×•×œ</button>
            </div>
        </div>
    </header>

    <main class="max-w-[1500px] mx-auto">
        
        <section id="view-entry" class="p-4">
            <div class="modal-content mx-auto shadow-xl border border-purple-100">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">×¨×™×©×•× ×¢×¡×§×” ×—×“×©×”</h2>
                <div class="space-y-1 text-right">
                    <label class="text-sm font-bold text-gray-600">×©× ×”×œ×§×•×—×”</label>
                    <input type="text" id="inc-name" placeholder="×©× ××œ×">
                    
                    <label class="text-sm font-bold text-gray-600">×¡×›×•× ×”×¢×¡×§×”</label>
                    <input type="number" id="inc-amount" placeholder="0.00 â‚ª">
                    
                    <label class="text-sm font-bold text-gray-600">×¡×•×’ ×”×©×™×¨×•×ª (×—×•×¤×©×™)</label>
                    <input type="text" id="inc-service" placeholder="×œ××©×œ: ××™×¤×•×¨ ×¢×¨×‘ + ×©×™×¢×¨">
                    
                    <label class="text-sm font-bold text-gray-600">×ª××¨×™×š</label>
                    <input type="date" id="inc-date">
                    
                    <label class="text-sm font-bold text-gray-600">×©×™×˜×ª ×ª×©×œ×•×</label>
                    <select id="inc-method">
                        <option value="××–×•××Ÿ">××–×•××Ÿ</option>
                        <option value="×‘×™×˜/×¤×™×™×‘×•×§×¡">×‘×™×˜ / ×¤×™×™×‘×•×§×¡</option>
                        <option value="×”×¢×‘×¨×” ×‘× ×§××™×ª">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                        <option value="××©×¨××™">×›×¨×˜×™×¡ ××©×¨××™</option>
                    </select>

                    <label class="flex items-center gap-3 p-4 bg-purple-50 rounded-xl cursor-pointer hover:bg-purple-100 transition">
                        <input type="checkbox" id="inc-bride" class="w-5 h-5 accent-purple-600">
                        <span class="font-bold text-purple-800 text-lg">×¢×¡×§×ª ×›×œ×”? ğŸ‘°</span>
                    </label>
                    
                    <button onclick="handleIncomeSubmit()" id="save-btn" class="w-full mt-6 bg-purple-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-purple-700 transition-all">
                        ×©××•×¨ ×‘×™×•××Ÿ ×•×‘×©×™×˜×¡
                    </button>
                </div>
            </div>
        </section>

        <section id="view-leads" class="hidden p-2">
            <div class="flex justify-between items-center mb-4 px-4">
                <button onclick="openModal('lead-modal')" class="bg-purple-600 text-white px-6 py-2 rounded-full font-bold shadow-md">+ ×”×•×¡×¤×ª ×œ×™×“</button>
                <div class="text-right">
                    <h2 class="text-xl font-extrabold text-purple-900 leading-tight">× ×™×”×•×œ ×ª×”×œ×™×›×™ ×œ×§×•×—×•×ª</h2>
                    <p class="text-xs text-gray-500">×’×¨×™×¨×” ×œ×”×—×œ×¤×ª ×¡×˜×˜×•×¡</p>
                </div>
            </div>
            <div class="kanban-wrapper" id="kanban-board">
                </div>
        </section>

        <section id="view-stats" class="hidden p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-purple-500">
                    <p class="text-gray-500 font-bold">×”×›× ×¡×•×ª ×—×•×“×©×™×•×ª</p>
                    <h3 id="stat-total" class="text-3xl font-black text-purple-700">â‚ª0</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-pink-500">
                    <p class="text-gray-500 font-bold">×›×œ×•×ª ×”×—×•×“×©</p>
                    <h3 id="stat-brides" class="text-3xl font-black text-pink-600">0</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-blue-500">
                    <p class="text-gray-500 font-bold">×¡×”"×› ×¢×¡×§××•×ª</p>
                    <h3 id="stat-count" class="text-3xl font-black text-blue-600">0</h3>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-sm mb-8">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="openManagement()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-xl font-bold">âš™ï¸ ×¢×¨×™×›×ª × ×ª×•× ×™×</button>
                    <select id="month-filter" onchange="refreshStats()" class="!w-40 !mb-0 font-bold"></select>
                </div>
                <div class="h-64">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </section>
    </main>

    <div id="lead-modal" class="modal">
        <div class="modal-content text-right">
            <h3 class="text-xl font-bold mb-4">×™×¦×™×¨×ª ×œ×™×“ ×—×“×©</h3>
            <input type="text" id="l-name" placeholder="×©× ×”×œ×§×•×—×” *">
            <input type="tel" id="l-phone" placeholder="×˜×œ×¤×•×Ÿ">
            <label class="text-xs text-gray-400">××§×•×¨ ×”×’×¢×”:</label>
            <select id="l-source">
                <option value="××™× ×¡×˜×’×¨×">××™× ×¡×˜×’×¨×</option>
                <option value="×¤×™×™×¡×‘×•×§">×¤×™×™×¡×‘×•×§</option>
                <option value="×˜×™×§×˜×•×§">×˜×™×§×˜×•×§</option>
                <option value="×—×‘×¨×”/×”××œ×¦×”">×—×‘×¨×” / ×”××œ×¦×”</option>
                <option value="××—×¨">××—×¨</option>
            </select>
            <input type="text" id="l-service" placeholder="×©×™×¨×•×ª ××‘×•×§×© (×—×•×¤×©×™)">
            <input type="date" id="l-date">
            <div class="flex gap-3 mt-4">
                <button onclick="handleLeadSubmit()" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold">×©××•×¨</button>
                <button onclick="closeModal('lead-modal')" class="flex-1 bg-gray-100 py-3 rounded-xl">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div id="manage-modal" class="modal">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <button id="bulk-del" onclick="handleBulkDelete()" class="hidden bg-red-500 text-white px-4 py-1 rounded-lg text-sm">××—×™×§×” ××¨×•×‘×”</button>
                <h3 class="font-bold text-xl">× ×™×”×•×œ ×©×•×¨×•×ª</h3>
                <button onclick="closeModal('manage-modal')" class="text-2xl">&times;</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-right">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="p-3"><input type="checkbox" id="master-check" onclick="toggleAllChecks(this)"></th>
                            <th class="p-3">×ª××¨×™×š</th>
                            <th class="p-3">×œ×§×•×—×”</th>
                            <th class="p-3">×¡×›×•×</th>
                            <th class="p-3">×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="manage-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION & STATE ---
        const SCRIPT_URL = 'YOUR_GOOGLE_SCRIPT_URL_HERE'; // ×—×•×‘×” ×œ×”×—×œ×™×£ ×‘×›×ª×•×‘×ª ×©×œ×š
        let state = {
            incomes: JSON.parse(localStorage.getItem('crm_inc_v10')) || [],
            leads: JSON.parse(localStorage.getItem('crm_leads_v10')) || [],
            chart: null
        };

        const STAGES = [
            {id: 'new', label: '×—×“×©'},
            {id: 'contact', label: '×§×©×¨'},
            {id: 'meeting', label: '××•"×'},
            {id: 'offer', label: '×”×¦×¢×”'},
            {id: 'closed', label: '×¡×’×¨'},
            {id: 'archive', label: '××¨×›×™×•×Ÿ'}
        ];

        const MONTHS = ["×™× ×•××¨", "×¤×‘×¨×•××¨", "××¨×¥", "××¤×¨×™×œ", "×××™", "×™×•× ×™", "×™×•×œ×™", "××•×’×•×¡×˜", "×¡×¤×˜××‘×¨", "××•×§×˜×•×‘×¨", "× ×•×‘××‘×¨", "×“×¦××‘×¨"];

        // --- INITIALIZATION ---
        window.onload = () => {
            document.getElementById('inc-date').valueAsDate = new Date();
            initMonthFilter();
            renderKanban();
            refreshStats();
        };

        function initMonthFilter() {
            const select = document.getElementById('month-filter');
            const curr = new Date().getMonth();
            MONTHS.forEach((m, i) => {
                const opt = new Option(m, m);
                if(i === curr) opt.selected = true;
                select.add(opt);
            });
            select.add(new Option("×©× ×ª×™", "ALL"));
        }

        // --- CORE LOGIC: INCOMES ---
        async function handleIncomeSubmit() {
            const btn = document.getElementById('save-btn');
            const data = {
                id: Date.now(),
                type: 'INCOME',
                name: document.getElementById('inc-name').value.trim(),
                amount: parseFloat(document.getElementById('inc-amount').value),
                service: document.getElementById('inc-service').value.trim(),
                date: document.getElementById('inc-date').value,
                method: document.getElementById('inc-method').value,
                isBride: document.getElementById('inc-bride').checked,
                month: MONTHS[new Date(document.getElementById('inc-date').value).getMonth()]
            };

            if(!data.name || isNaN(data.amount)) return alert("×× × ××œ× ×©× ×•×¡×›×•× ×ª×§×™×Ÿ");

            // 1. Save Locally (Instant Feedback)
            state.incomes.push(data);
            saveToStorage();
            
            // 2. Clear UI
            document.getElementById('inc-name').value = '';
            document.getElementById('inc-amount').value = '';
            alert("× ×©××¨ ×‘×”×¦×œ×—×”!");

            // 3. Sync to Google Sheets (Background)
            btn.innerText = "××¡× ×›×¨×Ÿ ×œ×©×™×˜×¡...";
            try {
                await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify(data) 
                });
                btn.innerText = "×©××•×¨ ×‘×™×•××Ÿ ×•×‘×©×™×˜×¡";
            } catch (e) {
                console.error("Sync failed, saved locally only");
                btn.innerText = "×©××•×¨ (×©×’×™××ª ×¡× ×›×¨×•×Ÿ)";
            }
        }

        // --- CORE LOGIC: LEADS (KANBAN) ---
        function renderKanban() {
            const board = document.getElementById('kanban-board');
            board.innerHTML = STAGES.map(stage => `
                <div class="kanban-col">
                    <h3>${stage.label}</h3>
                    <div class="kanban-list" data-stage="${stage.id}" id="list-${stage.id}">
                        ${state.leads.filter(l => l.status === stage.id).map(l => `
                            <div class="lead-card" data-id="${l.id}">
                                <span class="name font-bold block">${l.name}</span>
                                <span class="text-[10px] text-gray-500">${l.service || '×›×œ×œ×™'}</span>
                                <div class="flex justify-between mt-2">
                                    <span class="text-[9px] bg-purple-100 text-purple-700 px-1 rounded">${l.source}</span>
                                    <button onclick="deleteLead(${l.id})" class="text-red-300 hover:text-red-500 text-xs">ğŸ—‘</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            STAGES.forEach(stage => {
                new Sortable(document.getElementById(`list-${stage.id}`), {
                    group: 'leads',
                    animation: 150,
                    ghostClass: 'bg-purple-50',
                    onEnd: (evt) => {
                        const leadId = evt.item.getAttribute('data-id');
                        const newStatus = evt.to.getAttribute('data-stage');
                        updateLeadStatus(parseInt(leadId), newStatus);
                    }
                });
            });
        }

        async function handleLeadSubmit() {
            const data = {
                id: Date.now(),
                type: 'LEAD_NEW',
                status: 'new',
                name: document.getElementById('l-name').value.trim(),
                phone: document.getElementById('l-phone').value,
                source: document.getElementById('l-source').value,
                service: document.getElementById('l-service').value,
                date: document.getElementById('l-date').value
            };

            if(!data.name) return alert("×—×•×‘×” ×œ×”×–×™×Ÿ ×©× ×œ×§×•×—×”");

            state.leads.push(data);
            saveToStorage();
            renderKanban();
            closeModal('lead-modal');
            
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
        }

        function updateLeadStatus(id, newStatus) {
            const lead = state.leads.find(l => l.id === id);
            if(lead) {
                lead.status = newStatus;
                saveToStorage();
                fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify({ type: 'LEAD_MOVE', id, status: newStatus }) 
                });
            }
        }

        // --- MANAGEMENT & STATS ---
        function openManagement() {
            const tbody = document.getElementById('manage-table-body');
            tbody.innerHTML = state.incomes.sort((a,b) => new Date(b.date) - new Date(a.date)).map(inc => `
                <tr class="border-b">
                    <td class="p-3"><input type="checkbox" class="row-check" data-id="${inc.id}" onchange="toggleBulkBtn()"></td>
                    <td class="p-3 text-xs">${inc.date}</td>
                    <td class="p-3 font-bold">${inc.name}</td>
                    <td class="p-3 text-purple-600 font-bold">${inc.amount}â‚ª</td>
                    <td class="p-3">
                        <button onclick="deleteIncome(${inc.id})" class="text-red-500">××—×§</button>
                    </td>
                </tr>
            `).join('');
            openModal('manage-modal');
        }

        async function deleteIncome(id) {
            if(!confirm("×œ××—×•×§ ×¢×¡×§×” ×–×•?")) return;
            state.incomes = state.incomes.filter(i => i.id !== id);
            saveToStorage();
            openManagement();
            refreshStats();
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({type: 'DELETE_INC', id}) });
        }

        function refreshStats() {
            const filter = document.getElementById('month-filter').value;
            const filtered = filter === 'ALL' ? state.incomes : state.incomes.filter(i => i.month === filter);
            
            const total = filtered.reduce((s, i) => s + i.amount, 0);
            const brides = filtered.filter(i => i.isBride).length;
            
            document.getElementById('stat-total').innerText = 'â‚ª' + total.toLocaleString();
            document.getElementById('stat-brides').innerText = brides;
            document.getElementById('stat-count').innerText = filtered.length;

            updateChart(filter);
        }

        function updateChart(filter) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            let labels, data;

            if(filter === 'ALL') {
                labels = MONTHS;
                data = MONTHS.map(m => state.incomes.filter(i => i.month === m).reduce((s, i) => s + i.amount, 0));
            } else {
                labels = [filter];
                data = [state.incomes.filter(i => i.month === filter).reduce((s, i) => s + i.amount, 0)];
            }

            if(state.chart) state.chart.destroy();
            state.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '×”×›× ×¡×•×ª',
                        data: data,
                        backgroundColor: '#9333ea',
                        borderRadius: 10
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- UTILS ---
        function switchTab(t) {
            ['entry', 'leads', 'stats'].forEach(v => {
                document.getElementById('view-'+v).classList.add('hidden');
                document.getElementById('tab-'+v).classList.remove('active');
            });
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('tab-'+t).classList.add('active');
            if(t === 'leads') renderKanban();
            if(t === 'stats') refreshStats();
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function saveToStorage() {
            localStorage.setItem('crm_inc_v10', JSON.stringify(state.incomes));
            localStorage.setItem('crm_leads_v10', JSON.stringify(state.leads));
        }

        function toggleAllChecks(m) {
            document.querySelectorAll('.row-check').forEach(c => c.checked = m.checked);
            toggleBulkBtn();
        }

        function toggleBulkBtn() {
            const checked = document.querySelectorAll('.row-check:checked').length;
            document.getElementById('bulk-del').classList.toggle('hidden', checked === 0);
        }

        async function handleBulkDelete() {
            if(!confirm("×œ××—×•×§ ××ª ×›×œ ×”× ×‘×—×¨×™×?")) return;
            const ids = Array.from(document.querySelectorAll('.row-check:checked')).map(c => parseInt(c.dataset.id));
            state.incomes = state.incomes.filter(i => !ids.includes(i.id));
            saveToStorage();
            openManagement();
            refreshStats();
            ids.forEach(id => fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({type: 'DELETE_INC', id}) }));
        }
    </script>
</body>
</html>
