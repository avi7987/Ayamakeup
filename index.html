<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM ×—×›× ×¢× ×¤×•×œ×•-××¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');
        body { font-family: 'Heebo', sans-serif; background: #fdf2f8; }
        .main-card { background: white; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .nav-button { padding: 14px 28px; font-weight: bold; border-radius: 16px; transition: all 0.3s; }
        .nav-button.active { background: linear-gradient(135deg, #9333ea 0%, #db2777 100%); color: white; shadow: 0 8px 20px rgba(147, 51, 234, 0.3); }
        .nav-button:not(.active) { background: white; color: #9333ea; border: 2px solid #f3e8ff; }
        .kanban-col { background: rgba(243, 232, 255, 0.5); border-radius: 20px; padding: 16px; width: 310px; min-width: 310px; min-height: 70vh; }
        
        /* ×¢×™×¦×•×‘ ×›×¨×˜×™×¡ ×œ×™×“ */
        .lead-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-right: 6px solid #9333ea; position: relative; transition: all 0.4s ease; }
        .lead-urgent { background: #fff7ed !important; border-right-color: #f97316 !important; border-width: 2px; border-style: solid; border-color: #fb923c; transform: scale(1.02); z-index: 10; }
        
        .delete-btn { position: absolute; top: 8px; left: 8px; color: #ef4444; cursor: pointer; opacity: 0.2; }
        .delete-btn:hover { opacity: 1; }
        .modal { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; z-index: 100; fixed: inset 0; }
        input, select, textarea { border: 2px solid #f3e8ff !important; border-radius: 12px !important; padding: 10px !important; width: 100%; outline: none; }
        .automation-btn { font-size: 12px; color: #7c3aed; background: #f3e8ff; padding: 4px 10px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-full mx-auto">
        <div class="flex gap-4 justify-center mb-8">
            <button onclick="switchPage('entry')" id="nav-entry" class="nav-button active">ğŸ’° ×”×›× ×¡×•×ª</button>
            <button onclick="switchPage('leads')" id="nav-leads" class="nav-button">ğŸ¯ ×œ×™×“×™×</button>
        </div>

        <div id="page-entry" class="main-card p-8 max-w-xl mx-auto">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-r-4 border-purple-500 pr-3">×”×–× ×ª ×”×›× ×¡×”</h2>
            <div class="space-y-4">
                <input type="text" id="inc-name" placeholder="×©× ×”×œ×§×•×—×”">
                <input type="number" id="inc-amount" placeholder="×¡×›×•× (â‚ª)">
                <input type="date" id="inc-date">
                <button onclick="saveIncome()" class="w-full bg-purple-600 text-white py-4 rounded-xl font-bold shadow-lg">×©××™×¨×”</button>
            </div>
        </div>

        <div id="page-leads" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">× ×™×”×•×œ ×¤×•×œ×•-××¤</h2>
                <button onclick="openModal('modal-lead')" class="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold">+ ×”×•×¡×¤×ª ×œ×™×“</button>
            </div>
            
            <div class="flex gap-6 overflow-x-auto pb-10" id="kanban-board">
                </div>
        </div>
    </div>

    <div id="modal-automation" class="modal fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl">
            <h2 id="auto-title" class="text-2xl font-bold mb-4">× ×™×”×•×œ ××•×˜×•××¦×™×”</h2>
            
            <label class="block text-sm font-bold mb-1">× ×•×¡×— ×”×•×“×¢×” ([×©×] ×™×•×—×œ×£ ×‘×©× ×”×œ×§×•×—×”):</label>
            <textarea id="auto-msg-text" class="h-24 mb-4"></textarea>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-bold mb-1">×˜×™×™××¨ 1 (×“×§×•×ª):</label>
                    <input type="number" id="auto-t1" placeholder="×œ××©×œ 30">
                    <p class="text-[10px] text-gray-500">×–××Ÿ ×¢×“ ×œ×©×œ×™×—×” ×¨××©×•× ×”</p>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">×˜×™×™××¨ 2 (×“×§×•×ª):</label>
                    <input type="number" id="auto-t2" placeholder="×œ××©×œ 1440">
                    <p class="text-[10px] text-gray-500">×–××Ÿ ×œ×ª×–×›×•×¨×ª × ×•×¡×¤×ª</p>
                </div>
            </div>

            <input type="hidden" id="auto-col-id">
            <div class="flex gap-3">
                <button onclick="saveAutomation()" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold">×©××™×¨×”</button>
                <button onclick="closeModal('modal-automation')" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div id="modal-lead" class="modal fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl">
            <h2 class="text-2xl font-bold mb-4">×œ×™×“ ×—×“×©</h2>
            <div class="space-y-4">
                <input type="text" id="ln-name" placeholder="×©× ×”×œ×§×•×—×”">
                <input type="tel" id="ln-phone" placeholder="×˜×œ×¤×•×Ÿ">
                <button onclick="saveLead()" class="w-full bg-purple-600 text-white py-4 rounded-xl font-bold">×”×•×¡×¤×”</button>
                <button onclick="closeModal('modal-lead')" class="w-full text-gray-400">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <script>
        // ×§×•× ×¤×™×’×•×¨×¦×™×” ×©×œ ×”×¢××•×“×•×ª
        const COLUMNS = [
            { id: 'new', title: 'ğŸ†• ×¤× ×™×™×”', color: 'gray' },
            { id: 'contact', title: 'ğŸ“ ×™×¦×™×¨×ª ×§×©×¨', color: 'blue' },
            { id: 'negotiation', title: 'ğŸ’¬ ××•"×', color: 'orange' },
            { id: 'offer', title: 'ğŸ“„ ×”×¦×¢×”', color: 'pink' },
            { id: 'closed', title: 'âœ… × ×¡×’×¨', color: 'green' }
        ];

        let leads = JSON.parse(localStorage.getItem('crm_leads_v5')) || [];
        let config = JSON.parse(localStorage.getItem('crm_config')) || {};

        // ××ª×—×•×œ ×”×’×“×¨×•×ª ×‘×¨×™×¨×ª ××—×“×œ ×× ×¨×™×§
        COLUMNS.forEach(col => {
            if (!config[col.id]) {
                config[col.id] = { msg: "×”×™×™ [×©×], ××” ×©×œ×•××š?", t1: 30, t2: 1440 };
            }
        });

        window.onload = () => {
            switchPage('entry');
            setInterval(checkTimers, 10000); // ×‘×“×™×§×ª ×˜×™×™××¨×™× ×›×œ 10 ×©× ×™×•×ª
        };

        function switchPage(page) {
            document.getElementById('page-entry').classList.toggle('hidden', page !== 'entry');
            document.getElementById('page-leads').classList.toggle('hidden', page !== 'leads');
            document.getElementById('nav-entry').className = page === 'entry' ? 'nav-button active' : 'nav-button';
            document.getElementById('nav-leads').className = page === 'leads' ? 'nav-button active' : 'nav-button';
            if(page === 'leads') renderBoard();
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- × ×™×”×•×œ ××•×˜×•××¦×™×” ---
        function openMsgEditor(colId) {
            const c = config[colId];
            document.getElementById('auto-col-id').value = colId;
            document.getElementById('auto-msg-text').value = c.msg;
            document.getElementById('auto-t1').value = c.t1;
            document.getElementById('auto-t2').value = c.t2;
            openModal('modal-automation');
        }

        function saveAutomation() {
            const id = document.getElementById('auto-col-id').value;
            config[id] = {
                msg: document.getElementById('auto-msg-text').value,
                t1: parseInt(document.getElementById('auto-t1').value),
                t2: parseInt(document.getElementById('auto-t2').value)
            };
            localStorage.setItem('crm_config', JSON.stringify(config));
            closeModal('modal-automation');
            renderBoard();
        }

        // --- × ×™×”×•×œ ×œ×™×“×™× ×•×˜×™×™××¨×™× ---
        function saveLead() {
            const name = document.getElementById('ln-name').value;
            const phone = document.getElementById('ln-phone').value;
            if(!name || !phone) return;
            
            const newLead = {
                id: Date.now(),
                name,
                phone,
                status: 'new',
                enterStatusTime: Date.now(),
                lastSentTime: null,
                isUrgent: false
            };
            leads.push(newLead);
            save();
            closeModal('modal-lead');
            renderBoard();
        }

        function updateStatus(id, newStatus) {
            const lead = leads.find(l => l.id === id);
            lead.status = newStatus;
            lead.enterStatusTime = Date.now(); // ××™×¤×•×¡ ×–××Ÿ ×›× ×™×¡×” ×œ×¡×˜×˜×•×¡
            lead.lastSentTime = null; // ××™×¤×•×¡ ×–××Ÿ ×©×œ×™×—×”
            lead.isUrgent = false;
            save();
            renderBoard();
        }

        function sendWhatsApp(id) {
            const lead = leads.find(l => l.id === id);
            const colConfig = config[lead.status];
            const msg = colConfig.msg.replace('[×©×]', lead.name);
            
            // ×¢×“×›×•×Ÿ ×©×”×•×“×¢×” × ×©×œ×—×”
            lead.lastSentTime = Date.now();
            lead.isUrgent = false;
            save();
            renderBoard();

            const waLink = `https://wa.me/972${lead.phone.replace(/^0/, '')}?text=${encodeURIComponent(msg)}`;
            window.open(waLink, '_blank');
        }

        function checkTimers() {
            let changed = false;
            const now = Date.now();

            leads.forEach(lead => {
                const colConf = config[lead.status];
                if (!colConf) return;

                const timeInStatusMin = (now - lead.enterStatusTime) / 60000;
                
                if (!lead.lastSentTime) {
                    // ×˜×™×™××¨ 1 - ×œ×¤× ×™ ×©×œ×™×—×” ×¨××©×•× ×”
                    if (timeInStatusMin >= colConf.t1 && !lead.isUrgent) {
                        lead.isUrgent = true;
                        changed = true;
                    }
                } else {
                    // ×˜×™×™××¨ 2 - ××—×¨×™ ×©×œ×™×—×” ×¨××©×•× ×”
                    const timeSinceSentMin = (now - lead.lastSentTime) / 60000;
                    if (timeSinceSentMin >= colConf.t2 && !lead.isUrgent) {
                        lead.isUrgent = true;
                        changed = true;
                    }
                }
            });

            if (changed) {
                save();
                if (!document.getElementById('page-leads').classList.contains('hidden')) {
                    renderBoard();
                }
            }
        }

        function renderBoard() {
            const board = document.getElementById('kanban-board');
            board.innerHTML = '';

            COLUMNS.forEach(col => {
                const colDiv = document.createElement('div');
                colDiv.className = 'kanban-col';
                colDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-${col.color}-700">${col.title}</h3>
                        <div onclick="openMsgEditor('${col.id}')" class="automation-btn">âš™ï¸ × ×™×”×•×œ ××•×˜×•××¦×™×”</div>
                    </div>
                    <div id="cards-${col.id}" class="space-y-4"></div>
                `;
                board.appendChild(colDiv);

                const container = document.getElementById(`cards-${col.id}`);
                
                // ××™×•×Ÿ: ×“×—×•×¤×™× (Urgent) ×œ××¢×œ×”
                const colLeads = leads.filter(l => l.status === col.id)
                    .sort((a, b) => b.isUrgent - a.isUrgent);

                colLeads.forEach(lead => {
                    const card = document.createElement('div');
                    card.className = `lead-card ${lead.isUrgent ? 'lead-urgent' : ''}`;
                    card.innerHTML = `
                        <div class="delete-btn" onclick="deleteLead(${lead.id})">âœ–</div>
                        <div class="font-bold text-gray-800">${lead.name} ${lead.isUrgent ? 'ğŸ””' : ''}</div>
                        <div class="text-xs text-gray-500 mb-3">${lead.phone}</div>
                        
                        <button onclick="sendWhatsApp(${lead.id})" class="w-full py-2 bg-green-500 text-white rounded-lg text-xs font-bold mb-2 shadow-sm">
                            ${lead.isUrgent ? '×©×œ×—×™ ×¢×›×©×™×•!' : '×©×œ×—×™ ×”×•×“×¢×”'}
                        </button>

                        <select onchange="updateStatus(${lead.id}, this.value)" class="text-[10px] bg-gray-50 border-none">
                            ${COLUMNS.map(c => `<option value="${c.id}" ${lead.status === c.id ? 'selected' : ''}>×”×¢×‘×¨ ×œ: ${c.title}</option>`).join('')}
                        </select>
                    `;
                    container.appendChild(card);
                });
            });
        }

        function deleteLead(id) {
            if(confirm('×œ××—×•×§?')) {
                leads = leads.filter(l => l.id !== id);
                save();
                renderBoard();
            }
        }

        function save() { localStorage.setItem('crm_leads_v5', JSON.stringify(leads)); }

        async function saveIncome() {
            alert('×”×›× ×¡×” × ×©××¨×” (×¡×™××•×œ×¦×™×”)');
            document.getElementById('inc-name').value = '';
        }
    </script>
</body>
</html>
