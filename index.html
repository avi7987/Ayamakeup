<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ×¢×¡×§ - ××™×¤×•×¨ ×•×©×™×¢×¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');
        body { font-family: 'Heebo', sans-serif; }
        
        .nav-button { padding: 12px 24px; font-weight: bold; border-radius: 12px; cursor: pointer; transition: all 0.3s; border: 3px solid transparent; }
        .nav-button.active { background: linear-gradient(135deg, #9c27b0 0%, #e91e63 100%); color: white; box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4); }
        .nav-button:not(.active) { background: white; color: #9c27b0; border-color: #e1bee7; }
        
        .kanban-col { background: #f1f5f9; border-radius: 1rem; padding: 12px; width: 280px; min-width: 280px; min-height: 500px; }
        .lead-card { background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-right: 5px solid #6366f1; cursor: pointer; }
        .spinner { border: 2px solid #f3f4f6; border-top: 2px solid #9333ea; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-4 md:p-6">
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">××¢×¨×›×ª × ×™×”×•×œ ×¢×¡×§×™</h1>
            <div class="flex gap-3 justify-center flex-wrap">
                <button onclick="switchPage('entry')" id="nav-entry" class="nav-button active">â• ×”×–× ×ª ×œ×§×•×—×”</button>
                <button onclick="switchPage('leads')" id="nav-leads" class="nav-button">ğŸ¯ × ×™×”×•×œ ×œ×™×“×™×</button>
                <button onclick="switchPage('stats')" id="nav-stats" class="nav-button">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×”</button>
                <button onclick="openTemplateModal()" class="bg-pink-100 text-pink-700 px-4 py-2 rounded-xl font-bold">ğŸ’¬ ×ª×‘× ×™×•×ª ×”×•×“×¢×”</button>
            </div>
        </div>

        <div id="page-entry" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-6 text-purple-700">×”×–× ×ª ×¢×¡×§×” ×—×“×©×”</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="name" placeholder="×©× ×”×œ×§×•×—×” *" class="p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                    <input type="text" id="service" placeholder="×©×™×¨×•×ª *" class="p-3 border rounded-lg">
                    <input type="number" id="amount" placeholder="×¡×›×•× (â‚ª) *" class="p-3 border rounded-lg">
                    <input type="date" id="date" class="p-3 border rounded-lg">
                    <select id="paymentMethod" class="p-3 border rounded-lg">
                        <option value="××–×•××Ÿ">××–×•××Ÿ</option>
                        <option value="×‘×™×˜/×¤×™×™×‘×•×§×¡">×‘×™×˜/×¤×™×™×‘×•×§×¡</option>
                        <option value="×”×¢×‘×¨×” ×‘× ×§××™×ª">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                    </select>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="isBride" class="w-5 h-5">
                        <label>×”×× ×–××ª ×›×œ×”?</label>
                    </div>
                </div>
                <textarea id="notes" placeholder="×”×¢×¨×•×ª..." class="w-full p-3 border rounded-lg"></textarea>
                <button onclick="submitForm()" id="submitBtn" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700 transition">×©××•×¨ ×œ×§×•×—×”</button>
            </div>
        </div>

        <div id="page-leads" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ¯ ×œ×•×— ×œ×™×“×™×</h2>
                <button onclick="openNewLeadModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold shadow">+ ×œ×™×“ ×—×“×©</button>
            </div>
            <div class="flex gap-4 overflow-x-auto pb-6">
                <div class="kanban-col"><h3 class="font-bold mb-3">ğŸ†• ×¤× ×™×™×” ×—×“×©×”</h3><div id="col-new" class="space-y-3"></div></div>
                <div class="kanban-col"><h3 class="font-bold mb-3">ğŸ“ ×™×¦×™×¨×ª ×§×©×¨</h3><div id="col-contact" class="space-y-3"></div></div>
                <div class="kanban-col"><h3 class="font-bold mb-3">ğŸ’¬ ××©× ×•××ª×Ÿ</h3><div id="col-negotiation" class="space-y-3"></div></div>
                <div class="kanban-col"><h3 class="font-bold mb-3">ğŸ“„ ×”×¦×¢×”/×—×•×–×”</h3><div id="col-offer" class="space-y-3"></div></div>
                <div class="kanban-col"><h3 class="font-bold mb-3">ğŸ—„ï¸ ××¨×›×™×•×Ÿ</h3><div id="col-archive" class="space-y-3"></div></div>
            </div>
        </div>

        <div id="page-stats" class="hidden bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">ğŸ“Š ×¨×™×›×•×– ×”×›× ×¡×•×ª</h2>
            <select id="periodSelector" onchange="updateStats()" class="w-full mb-8 p-3 border-2 border-purple-300 rounded-lg text-lg"></select>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-pink-100 p-8 rounded-2xl text-center shadow">
                    <div class="text-xl font-bold mb-2">ğŸ‘° ×›××•×ª ×›×œ×•×ª</div>
                    <div id="bridesCounter" class="text-5xl font-bold text-pink-600">0</div>
                </div>
                <div class="bg-purple-100 p-8 rounded-2xl text-center shadow">
                    <div class="text-xl font-bold mb-2">ğŸ’° ×¡×”"×› ×”×›× ×¡×•×ª</div>
                    <div id="totalIncome" class="text-5xl font-bold text-purple-600">â‚ª0</div>
                </div>
            </div>
            <canvas id="incomeChart" style="max-height: 400px;"></canvas>
        </div>
    </div>

    <div id="modal-lead" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">×¤×¨×˜×™ ×œ×™×“ ×—×“×©</h2>
            <input type="text" id="ln-name" placeholder="×©× ×”×œ×§×•×—×”" class="w-full p-3 border rounded-lg mb-3">
            <input type="tel" id="ln-phone" placeholder="×˜×œ×¤×•×Ÿ" class="w-full p-3 border rounded-lg mb-3">
            <label class="text-sm font-bold">×ª×–×›×•×¨×ª ×¤×•×œ×•-××¤ ×‘×¢×•×“ (×©×¢×•×ª):</label>
            <input type="number" id="ln-timer" value="24" class="w-full p-3 border rounded-lg mb-4">
            <button onclick="saveNewLead()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold">×”×•×¡×£ ×œ××¢×§×‘</button>
            <button onclick="closeModal('modal-lead')" class="w-full mt-2 text-gray-500">×‘×™×˜×•×œ</button>
        </div>
    </div>

    <div id="modal-templates" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4 text-pink-600">×ª×‘× ×™×•×ª ×”×•×“×¢×”</h2>
            <textarea id="tpl-new" class="w-full p-2 border rounded-lg h-24 mb-4">×”×™×™ [×©×], ××™×–×” ×›×™×£ ×©×¤× ×™×ª ××œ×™×™! ××©××— ×œ×“×¢×ª ××” ×”×ª××¨×™×š ×•×”××™×§×•× ×›×“×™ ×œ×‘×“×•×§ ×–××™× ×•×ª?</textarea>
            <textarea id="tpl-offer" class="w-full p-2 border rounded-lg h-24">××–×œ ×˜×•×‘ [×©×]! ×¦×™×¨×¤×ª×™ ×›××Ÿ ××ª ×”×¤×¨×˜×™× ×•×”×—×•×–×” ×œ×©×¨×™×•×Ÿ ×”××•×¢×“...</textarea>
            <button onclick="closeModal('modal-templates')" class="w-full bg-pink-600 text-white py-3 rounded-lg font-bold">×©××•×¨</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbydwcb9Elv-S-xFhySVkioiaJrLPwx7I9LxzSLY6ep_aR22ErmKBEuAUG_ZPp0u1JghHw/exec';
        let clients = JSON.parse(localStorage.getItem('clientsData')) || [];
        let leads = JSON.parse(localStorage.getItem('crm_leads_v3')) || [];
        let incomeChart = null;

        document.getElementById('date').valueAsDate = new Date();

        function switchPage(page) {
            ['entry', 'leads', 'stats'].forEach(p => {
                document.getElementById(`page-${p}`).classList.add('hidden');
                document.getElementById(`nav-${p}`).classList.remove('active');
            });
            document.getElementById(`page-${page}`).classList.remove('hidden');
            document.getElementById(`nav-${page}`).classList.add('active');
            if (page === 'stats') updateStats();
            if (page === 'leads') renderLeadsBoard();
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×œ×™×“×™× ---
        function openNewLeadModal() { document.getElementById('modal-lead').classList.remove('hidden'); }
        function openTemplateModal() { document.getElementById('modal-templates').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function saveNewLead() {
            const name = document.getElementById('ln-name').value;
            const phone = document.getElementById('ln-phone').value;
            const timer = document.getElementById('ln-timer').value;
            if(!name || !phone) return alert("× × ×œ××œ× ×¤×¨×˜×™×");
            const lead = { id: Date.now(), name, phone, status: 'new', history: [{status: '×¤× ×™×™×” ×—×“×©×”', time: new Date().toLocaleString()}], timer };
            leads.unshift(lead);
            saveLeads();
            closeModal('modal-lead');
            setTimeout(() => alert(`â° ×ª×–×›×•×¨×ª ×¤×•×œ×•-××¤: ×‘×“×§×™ ××” ×§×•×¨×” ×¢× ×”×œ×™×“: ${name}`), timer * 3600000);
        }

        function updateLeadStatus(id, newStatus) {
            const lead = leads.find(l => l.id === id);
            lead.status = newStatus;
            lead.history.push({status: newStatus, time: new Date().toLocaleString()});
            if (newStatus === 'closed') {
                alert('××–×œ ×˜×•×‘ ×¢×œ ×”×¡×’×™×¨×”! ×¢×•×‘×¨×™× ×œ××™×œ×•×™ ×”×¤×¨×˜×™×...');
                switchPage('entry');
                document.getElementById('name').value = lead.name;
                return;
            }
            saveLeads();
        }

        function renderLeadsBoard() {
            const cols = ['new', 'contact', 'negotiation', 'offer', 'archive'];
            cols.forEach(c => document.getElementById(`col-${c}`).innerHTML = '');
            leads.forEach(lead => {
                const card = document.createElement('div');
                card.className = "lead-card mb-3";
                card.innerHTML = `
                    <div class="font-bold text-gray-800">${lead.name}</div>
                    <div class="text-sm text-gray-500 mb-2">${lead.phone}</div>
                    <select onchange="updateLeadStatus(${lead.id}, this.value)" class="w-full text-xs p-1 border rounded mb-2">
                        <option value="new" ${lead.status === 'new' ? 'selected' : ''}>ğŸ†• ×¤× ×™×™×”</option>
                        <option value="contact" ${lead.status === 'contact' ? 'selected' : ''}>ğŸ“ ×™×¦×™×¨×ª ×§×©×¨</option>
                        <option value="negotiation" ${lead.status === 'negotiation' ? 'selected' : ''}>ğŸ’¬ ××©× ×•××ª×Ÿ</option>
                        <option value="offer" ${lead.status === 'offer' ? 'selected' : ''}>ğŸ“„ ×—×•×–×”/×”×¦×¢×”</option>
                        <option value="closed">âœ… × ×¡×’×¨ ×‘×”×¦×œ×—×”</option>
                        <option value="rejected" ${lead.status === 'rejected' ? 'selected' : ''}>âŒ ×œ× ×¨×œ×•×•× ×˜×™</option>
                    </select>
                    <button onclick="openWhatsApp('${lead.phone}', '${lead.name}', '${lead.status}')" class="w-full bg-green-500 text-white text-[10px] py-1 rounded">×©×œ×—×™ ×”×•×“×¢×”</button>
                `;
                let target = (lead.status === 'rejected' || lead.status === 'closed') ? 'archive' : lead.status;
                document.getElementById(`col-${target}`).appendChild(card);
            });
        }

        function openWhatsApp(phone, name, status) {
            let msg = document.getElementById(status === 'offer' ? 'tpl-offer' : 'tpl-new').value.replace('[×©×]', name);
            window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`);
        }

        function saveLeads() { localStorage.setItem('crm_leads_v3', JSON.stringify(leads)); renderLeadsBoard(); }

        // --- ×¤×•× ×§×¦×™×•×ª ×”×›× ×¡×•×ª (×”××§×•×¨×™×•×ª) ---
        async function submitForm() {
            const name = document.getElementById('name').value;
            const service = document.getElementById('service').value;
            const amount = document.getElementById('amount').value;
            const date = document.getElementById('date').value;
            if (!name || !service || !amount || !date) return alert('× × ×œ××œ× ×©×“×•×ª ×—×•×‘×”');

            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerHTML = '<div class="spinner mx-auto"></div>';
            
            const data = { 
                name, service, amount: parseFloat(amount), 
                paymentMethod: document.getElementById('paymentMethod').value,
                date, isBride: document.getElementById('isBride').checked,
                notes: document.getElementById('notes').value,
                month: new Date(date).toLocaleDateString('he-IL', {year:'numeric', month:'long'}),
                id: Date.now()
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                clients.push(data);
                localStorage.setItem('clientsData', JSON.stringify(clients));
                alert('× ×©××¨ ×‘×”×¦×œ×—×”!');
                document.getElementById('name').value = '';
                switchPage('stats');
            } catch (e) { alert('×©×’×™××” ×‘×©××™×¨×”'); }
            btn.disabled = false; btn.textContent = '×©××•×¨ ×œ×§×•×—×”';
        }

        function updateStats() {
            const total = clients.reduce((s, c) => s + c.amount, 0);
            const brides = clients.filter(c => c.isBride).length;
            document.getElementById('totalIncome').textContent = `â‚ª${total.toLocaleString()}`;
            document.getElementById('bridesCounter').textContent = brides;
            // ×›××Ÿ ×ª×•×¡×¤×ª ×”×’×¨×£...
        }

        function populatePeriodSelector() {
            const selector = document.getElementById('periodSelector');
            const months = [...new Set(clients.map(c => c.month))];
            selector.innerHTML = '<option value="yearly">ğŸ—“ï¸ ×›×œ ×”×©× ×”</option>';
            months.forEach(m => selector.innerHTML += `<option value="${m}">ğŸ“… ${m}</option>`);
        }

        populatePeriodSelector();
        renderLeadsBoard();
    </script>
</body>
</html>
