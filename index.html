<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM ×™×•×¤×™ ×—×›× - × ×™×”×•×œ ××œ×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');
        body { font-family: 'Heebo', sans-serif; background: #fdf2f8; margin: 0; padding: 0; }
        .main-card { background: white; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .nav-button { padding: 14px 28px; font-weight: bold; border-radius: 16px; transition: all 0.3s; }
        .nav-button.active { background: linear-gradient(135deg, #9333ea 0%, #db2777 100%); color: white; }
        .nav-button:not(.active) { background: white; color: #9333ea; border: 2px solid #f3e8ff; }
        .kanban-col { background: rgba(243, 232, 255, 0.5); border-radius: 20px; padding: 16px; width: 300px; min-width: 300px; min-height: 600px; }
        .lead-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-right: 8px solid #9333ea; position: relative; }
        .is-urgent { background: #fff7ed !important; border: 2px solid #fb923c !important; }
        .modal { background: rgba(0,0,0,0.4); backdrop-filter: blur(6px); display: none; z-index: 100; position: fixed; inset: 0; align-items: center; justify-content: center; }
        input, select, textarea { border: 2px solid #f3e8ff !important; border-radius: 14px !important; padding: 10px !important; width: 100%; outline: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: right; padding: 12px; border-bottom: 1px solid #f3e8ff; }
        .auto-btn { font-size: 11px; background: white; border: 1px solid #e9d5ff; color: #9333ea; padding: 2px 6px; border-radius: 6px; cursor: pointer; }
        /* ×¢×™×¦×•×‘ ×œ×›×¤×ª×•×¨ ×× ×•×˜×¨×œ */
        button:disabled { background: #d1d5db !important; cursor: not-allowed; transform: scale(1) !important; box-shadow: none !important; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-wrap gap-4 justify-center mb-10">
            <button onclick="switchPage('entry')" id="nav-entry" class="nav-button active">ğŸ’° ×”×–× ×ª ×”×›× ×¡×”</button>
            <button onclick="switchPage('leads')" id="nav-leads" class="nav-button">ğŸ¯ × ×™×”×•×œ ×œ×™×“×™×</button>
            <button onclick="switchPage('stats')" id="nav-stats" class="nav-button">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×” ×•× ×™×”×•×œ</button>
        </div>

        <div id="page-entry" class="main-card p-8 max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold mb-8 text-gray-800 border-r-4 border-purple-500 pr-4">×”×–× ×ª ×¢×¡×§×”</h2>
            <div class="space-y-6">
                <input type="text" id="inc-name" placeholder="×©× ×”×œ×§×•×—×” *">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="inc-service" placeholder="×¡×•×’ ×©×™×¨×•×ª">
                    <input type="number" id="inc-amount" placeholder="×¡×›×•×">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="inc-date">
                    <select id="inc-payment">
                        <option value="××–×•××Ÿ">××–×•××Ÿ</option>
                        <option value="×‘×™×˜/×¤×™×™×‘×•×§×¡">×‘×™×˜/×¤×™×™×‘×•×§×¡</option>
                        <option value="×”×¢×‘×¨×” ×‘× ×§××™×ª">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                    </select>
                </div>
                <div class="flex items-center gap-4 p-4 bg-purple-50 rounded-2xl">
                    <input type="checkbox" id="inc-isbride" class="w-6 h-6">
                    <label class="font-bold">×¡×× ×™ ×× ×–×• ×›×œ×” ğŸ‘°</label>
                </div>
                <button onclick="saveIncome()" id="inc-save-btn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-2xl font-bold shadow-lg transition-all active:scale-95">×©××™×¨×” ×‘×©×™×˜×¡</button>
            </div>
        </div>

        <div id="page-leads" class="hidden">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold">×œ×•×— ×¤×•×œ×•-××¤</h2>
                <button onclick="openModal('modal-lead')" class="bg-purple-600 text-white px-6 py-3 rounded-xl">+ ×œ×™×“ ×—×“×©</button>
            </div>
            <div class="flex gap-6 overflow-x-auto pb-8" id="board-container"></div>
        </div>

        <div id="page-stats" class="hidden">
            <div class="main-card p-6">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold">× ×™×ª×•×— ×•× ×™×”×•×œ × ×ª×•× ×™×</h2>
                    <div class="flex gap-2">
                        <button onclick="bulkDelete()" id="btn-bulk-delete" class="hidden bg-red-100 text-red-600 px-4 py-2 rounded-xl text-sm font-bold">××—×§ ××¡×•×× ×™×</button>
                        <select id="stats-month-filter" onchange="updateStats()" class="!w-48"></select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                    <div class="p-4 bg-purple-50 rounded-2xl"><div class="text-gray-500">×”×›× ×¡×•×ª</div><div id="sum-total" class="text-3xl font-bold text-purple-600">0 â‚ª</div></div>
                    <div class="p-4 bg-pink-50 rounded-2xl"><div class="text-gray-500">×›×œ×•×ª ğŸ‘°</div><div id="sum-brides" class="text-3xl font-bold text-pink-600">0</div></div>
                    <div class="p-4 bg-blue-50 rounded-2xl"><div class="text-gray-500">×¢×¡×§××•×ª</div><div id="sum-count" class="text-3xl font-bold text-blue-600">0</div></div>
                </div>

                <div class="h-[300px] mb-10"><canvas id="incomeChart"></canvas></div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th><input type="checkbox" id="master-check" onclick="toggleSelectAll(this)"></th>
                                <th>×ª××¨×™×š</th>
                                <th>×œ×§×•×—×”</th>
                                <th>×©×™×¨×•×ª</th>
                                <th>×¡×›×•×</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="stats-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-lead" class="modal"><div class="bg-white p-8 rounded-3xl w-full max-w-sm text-center">
        <h2 class="text-xl font-bold mb-4">×œ×™×“ ×—×“×©</h2>
        <input type="text" id="ln-name" placeholder="×©× ×”×œ×§×•×—×”" class="mb-4">
        <input type="tel" id="ln-phone" placeholder="×˜×œ×¤×•×Ÿ" class="mb-6">
        <button onclick="saveLead()" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold">×©××™×¨×”</button>
        <button onclick="closeModal('modal-lead')" class="w-full text-gray-400 mt-2">×‘×™×˜×•×œ</button>
    </div></div>

    <div id="modal-auto" class="modal"><div class="bg-white p-8 rounded-3xl w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">×”×’×“×¨×•×ª ×¡×˜×˜×•×¡</h2>
        <textarea id="auto-msg" class="h-24 mb-4" placeholder="×”×•×“×¢×ª ×•×•××˜×¡××¤..."></textarea>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <input type="number" id="auto-t1" placeholder="×˜×™×™××¨ 1 (×“×§')">
            <input type="number" id="auto-t2" placeholder="×˜×™×™××¨ 2 (×“×§')">
        </div>
        <input type="hidden" id="auto-col-id">
        <button onclick="saveAutoSettings()" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold">×©××™×¨×”</button>
        <button onclick="closeModal('modal-auto')" class="w-full text-gray-400 mt-2">×¡×’×•×¨</button>
    </div></div>

    <script>
        const SCRIPT_URL = '×›××Ÿ_×œ×”×“×‘×™×§_××ª_×”×›×ª×•×‘×ª_×©×œ×š';
        
        let leads = JSON.parse(localStorage.getItem('crm_leads_v7')) || [];
        let clients = JSON.parse(localStorage.getItem('clientsData')) || [];
        let autoConfig = JSON.parse(localStorage.getItem('crm_auto_v7')) || {};
        let myChart = null;

        const MONTHS = ["×™× ×•××¨", "×¤×‘×¨×•××¨", "××¨×¥", "××¤×¨×™×œ", "×××™", "×™×•× ×™", "×™×•×œ×™", "××•×’×•×¡×˜", "×¡×¤×˜××‘×¨", "××•×§×˜×•×‘×¨", "× ×•×‘××‘×¨", "×“×¦××‘×¨"];
        const COLUMNS = [{id:'new', title:'ğŸ†• ×¤× ×™×™×”'}, {id:'contact', title:'ğŸ“ ×§×©×¨'}, {id:'negotiation', title:'ğŸ’¬ ××•"×'}, {id:'offer', title:'ğŸ“„ ×”×¦×¢×”'}, {id:'closed', title:'âœ… × ×¡×’×¨'}];

        window.onload = () => {
            const filter = document.getElementById('stats-month-filter');
            filter.innerHTML = '<option value="all">×›×œ ×”×©× ×”</option>' + MONTHS.map(m => `<option value="${m}">${m}</option>`).join('');
            
            // ××™×¤×•×¡ ×ª××¨×™×š ×œ×”×™×•× ×‘×˜×¢×™× ×” ×¨××©×•× ×”
            resetEntryFields();
            switchPage('entry');
            setInterval(checkTimers, 30000); 
        };

        function switchPage(page) {
            ['entry', 'leads', 'stats'].forEach(p => document.getElementById(`page-${p}`).classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            if(page === 'stats') updateStats();
        }

        // ×¤×•× ×§×¦×™×™×ª ××™×¤×•×¡ ×©×“×•×ª
        function resetEntryFields() {
            document.getElementById('inc-name').value = '';
            document.getElementById('inc-service').value = '';
            document.getElementById('inc-amount').value = '';
            document.getElementById('inc-isbride').checked = false;
            document.getElementById('inc-date').valueAsDate = new Date();
            document.getElementById('inc-payment').value = '××–×•××Ÿ';
        }

        async function saveIncome() {
            const btn = document.getElementById('inc-save-btn');
            const name = document.getElementById('inc-name').value;
            const amount = document.getElementById('inc-amount').value;
            
            if(!name || !amount) return alert('×× × ××œ××™ ×©× ×•×¡×›×•×');

            const data = {
                id: Date.now(),
                type: 'INCOME',
                name: name,
                amount: parseFloat(amount),
                date: document.getElementById('inc-date').value,
                service: document.getElementById('inc-service').value,
                paymentMethod: document.getElementById('inc-payment').value,
                isBride: document.getElementById('inc-isbride').checked,
                month: MONTHS[new Date(document.getElementById('inc-date').value).getMonth()]
            };
            
            // 1. × ×˜×¨×•×œ ×›×¤×ª×•×¨ ×•×¦×‘×™×¢×” ×œ××¤×•×¨
            btn.disabled = true;
            btn.innerText = "×©×•××¨ × ×ª×•× ×™×...";

            try {
                // 2. ×©×œ×™×—×” ×œ×©×™×˜×¡
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                
                // 3. ×¢×“×›×•×Ÿ ××§×•××™
                clients.push(data);
                localStorage.setItem('clientsData', JSON.stringify(clients));
                
                // 4. ××™×¤×•×¡ ×©×“×•×ª ×•×ª××¨×™×š
                resetEntryFields();
                alert('×”×¢×¡×§×” × ×©××¨×” ×‘×”×¦×œ×—×”!');
            } catch (e) {
                alert('×©×’×™××” ×‘×©××™×¨×”. × ×¡×™ ×©×•×‘.');
            } finally {
                // 5. ×”×—×–×¨×ª ×”×›×¤×ª×•×¨ ×œ××¦×‘ ×¤×¢×™×œ
                btn.disabled = false;
                btn.innerText = "×©××™×¨×” ×‘×©×™×˜×¡";
            }
        }

        // --- ×©××¨ ×”×¤×•× ×§×¦×™×•×ª × ×©××¨×•×ª ×œ×œ× ×©×™× ×•×™ ---

        function updateStats() {
            const filter = document.getElementById('stats-month-filter').value;
            const filtered = filter === 'all' ? clients : clients.filter(c => c.month === filter);

            document.getElementById('sum-total').innerText = filtered.reduce((s, c) => s + c.amount, 0).toLocaleString() + ' â‚ª';
            document.getElementById('sum-count').innerText = filtered.length;
            document.getElementById('sum-brides').innerText = filtered.filter(c => c.isBride).length;

            const tbody = document.getElementById('stats-table-body');
            tbody.innerHTML = filtered.map(c => `
                <tr>
                    <td><input type="checkbox" class="row-select" data-id="${c.id}"></td>
                    <td>${c.date}</td>
                    <td><b>${c.name}</b></td>
                    <td>${c.service}</td>
                    <td>${c.amount} â‚ª</td>
                    <td><button onclick="deleteRow(${c.id})" class="text-red-500 font-bold">××—×§</button></td>
                </tr>`).join('');

            const chartLabels = [...new Set(filtered.map(c => filter === 'all' ? c.month : c.date))];
            const chartVals = chartLabels.map(l => filtered.filter(c => (filter === 'all' ? c.month : c.date) === l).reduce((s, c) => s + c.amount, 0));

            if (myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('incomeChart'), {
                type: 'bar',
                data: { labels: chartLabels, datasets: [{ label: '×”×›× ×¡×•×ª', data: chartVals, backgroundColor: '#9333ea', borderRadius: 10 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        async function deleteRow(id) {
            if(!confirm('×œ××—×•×§ ××”××ª×¨ ×•××”×©×™×˜×¡?')) return;
            const item = clients.find(c => c.id === id);
            clients = clients.filter(c => c.id !== id);
            localStorage.setItem('clientsData', JSON.stringify(clients));
            updateStats();
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'DELETE_ROW', name: item.name, amount: item.amount }) });
        }

        function renderBoard() {
            const container = document.getElementById('board-container');
            container.innerHTML = '';
            COLUMNS.forEach(col => {
                const colDiv = document.createElement('div');
                colDiv.className = 'kanban-col';
                colDiv.innerHTML = `<div class="flex justify-between mb-4"><h3 class="font-bold">${col.title}</h3><div onclick="openAutoEditor('${col.id}')" class="auto-btn">âš™ï¸</div></div><div id="cards-${col.id}" class="space-y-4"></div>`;
                container.appendChild(colDiv);
                
                leads.filter(l => l.status === col.id).sort((a,b) => b.urgent - a.urgent).forEach(l => {
                    const card = document.createElement('div');
                    card.className = `lead-card ${l.urgent ? 'is-urgent' : ''}`;
                    card.innerHTML = `<div class="font-bold">${l.name} ${l.urgent ? 'ğŸ””' : ''}</div><div class="text-xs mb-3 text-gray-500">${l.phone}</div>
                        <button onclick="sendWA(${l.id})" class="w-full py-2 bg-green-500 text-white rounded-lg text-xs font-bold mb-2 shadow-md">×©×œ×—×™ ×”×•×“×¢×”</button>
                        <select onchange="updateStatus(${l.id}, this.value)" class="text-[10px] bg-gray-50 border-none rounded-lg p-1">
                            ${COLUMNS.map(c => `<option value="${c.id}" ${l.status === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                        </select>`;
                    document.getElementById(`cards-${col.id}`).appendChild(card);
                });
            });
        }

        function checkTimers() {
            let changed = false;
            const now = Date.now();
            leads.forEach(l => {
                const conf = autoConfig[l.status] || {t1:30, t2:1440};
                const diff = (now - (l.lastSent || l.enterStatusAt)) / 60000;
                const limit = l.lastSent ? conf.t2 : conf.t1;
                if (diff >= limit && !l.urgent) { l.urgent = true; changed = true; }
            });
            if(changed) { localStorage.setItem('crm_leads_v7', JSON.stringify(leads)); renderBoard(); }
        }

        function sendWA(id) {
            const l = leads.find(x => x.id === id);
            const msg = (autoConfig[l.status]?.msg || "×”×™×™ [×©×]").replace('[×©×]', l.name);
            l.urgent = false; l.lastSent = Date.now();
            localStorage.setItem('crm_leads_v7', JSON.stringify(leads));
            renderBoard();
            window.open(`https://wa.me/972${l.phone.replace(/^0/, '')}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function updateStatus(id, stat) {
            const l = leads.find(x => x.id === id);
            l.status = stat; l.enterStatusAt = Date.now(); l.lastSent = null; l.urgent = false;
            localStorage.setItem('crm_leads_v7', JSON.stringify(leads));
            renderBoard();
        }

        function saveLead() {
            const name = document.getElementById('ln-name').value;
            const phone = document.getElementById('ln-phone').value;
            if(!name || !phone) return;
            leads.push({ id: Date.now(), name, phone, status: 'new', enterStatusAt: Date.now(), urgent: false });
            localStorage.setItem('crm_leads_v7', JSON.stringify(leads));
            closeModal('modal-lead'); renderBoard();
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openAutoEditor(id) { const c = autoConfig[id] || {msg:'', t1:30, t2:1440}; document.getElementById('auto-col-id').value = id; document.getElementById('auto-msg').value = c.msg; document.getElementById('auto-t1').value = c.t1; document.getElementById('auto-t2').value = c.t2; openModal('modal-auto'); }
        function saveAutoSettings() { const id = document.getElementById('auto-col-id').value; autoConfig[id] = { msg: document.getElementById('auto-msg').value, t1: parseInt(document.getElementById('auto-t1').value), t2: parseInt(document.getElementById('auto-t2').value) }; localStorage.setItem('crm_auto_v7', JSON.stringify(autoConfig)); closeModal('modal-auto'); renderBoard(); }
        function toggleSelectAll(m) { document.querySelectorAll('.row-select').forEach(cb => cb.checked = m.checked); document.getElementById('btn-bulk-delete').classList.toggle('hidden', !m.checked); }
        async function bulkDelete() { if(!confirm('×œ××—×•×§ ××¡×•×× ×™×?')) return; const sel = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.dataset.id); for(let id of sel) { await deleteRow(parseInt(id)); } }
    </script>
</body>
</html>
