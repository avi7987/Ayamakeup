# מדריך גרסה 11.0 - שדות שירות דינמיים

## סקירה כללית
גרסה זו משדרגת את מערכת הסדרת השירותים עם שדות חכמים ודינמיים למעקב מפורט יותר על שירותים ומחירים.

---

## 🆕 תכונות חדשות

### 1. שם משפחה חובה ביצירת ליד
- שדה `lastName` הפך לשדה חובה ביצירת ליד חדש
- **מיקום**: מסך יצירת ליד (כפתור + בלוח הקנבן)
- **תיקוף**: המערכת תמנע שמירת ליד ללא שם משפחה

### 2. מודל הזנת מחיר - שלב "בטיפול"
- כשמעבירים ליד לשלב **"בטיפול"** ללא מחיר - מופיע מודל
- **אופציות**:
  - ✅ **הזן מחיר** - פותח שדה הזנת מחיר
  - ⏭️ **דלג** - ממשיך ללא הזנת מחיר
- **שימוש**: מבטיח שכל ליד בטיפול יש לו מחיר מוגדר

### 3. ליווי - Dropdown במקום Checkbox
#### מבנה ישן (הוסר):
```
☑️ יש ליווי
מחיר ליווי: ____
```

#### מבנה חדש (v11.0):
```
סוג ליווי: [בחר אופציה ▼]
  - ללא ליווי
  - ליווי קצר
  - ליווי ארוך

מחיר ליווי: ____ (מופיע רק אם בחרת ליווי)
```

**איך זה עובד**:
- כשבוחרים "ללא ליווי" - שדה המחיר נעלם
- כשבוחרים "ליווי קצר" או "ליווי ארוך" - שדה המחיר מופיע

### 4. מלוות דינמיות - שורות נפרדות
#### מבנה ישן (הוסר):
```
☑️ יש מלוות
כמות מלוות: ____
מחיר כולל למלוות: ____
```

#### מבנה חדש (v11.0):
```
כמות מלוות: [0▼]

[כשבוחרים 3 למשל, נפתחות 3 שורות:]

━━━ מלווה 1 ━━━
שירות: _______________ (למשל: איפור + שיער)
מחיר: _____ ₪

━━━ מלווה 2 ━━━
שירות: _______________ (למשל: איפור בלבד)
מחיר: _____ ₪

━━━ מלווה 3 ━━━
שירות: _______________ (למשל: שיער בלבד)
מחיר: _____ ₪
```

**יתרונות**:
- מעקב מפורט לכל מלווה
- תיעוד מדויק של שירותים
- חוזה מפורט יותר עם פירוט לכל מלווה

---

## 📋 תהליך עבודה מעודכן

### יצירת ליד חדש
1. לחץ על כפתור **+** בלוח הקנבן
2. **מלא פרטים** (כולל שם משפחה - חובה!)
3. שמור

### מעבר לשלב "בטיפול"
1. גרור ליד לעמודה **"בטיפול"**
2. **אם אין מחיר** - מודל יופיע:
   - הזן מחיר ולחץ אישור
   - או לחץ "דלג" להמשיך
3. מסר WhatsApp נפתח אוטומטית

### מעבר לשלב "חוזה נשלח"
1. גרור ליד לעמודה **"חוזה נשלח"**
2. מודל יופיע עם:
   - שם משפחה (אוטומטית)
   - **ליווי**: בחר מהרשימה (ללא/קצר/ארוך)
   - אם בחרת ליווי → הזן מחיר
   - **מלוות**: בחר כמה מלוות
   - אם בחרת מלוות → מילוי שירות ומחיר לכל מלווה
3. לחץ **"צור חוזה ושלח"**
4. החוזה נוצר עם כל הפרטים והמחירים
5. מסר WhatsApp עם קישור לחוזה נפתח

---

## 📄 מבנה החוזה החדש

### טבלת שירותים
```
┌─────────────────────────────────────────────────────┐
│ תיאור השירות    │ פרטים            │ מחיר (₪)     │
├─────────────────────────────────────────────────────┤
│ איפור כלה       │ שירות עיקרי      │ 1,500        │
│ ליווי לאירוע    │ ליווי קצר        │ 500          │
│ מלווה 1         │ איפור + שיער     │ 350          │
│ מלווה 2         │ איפור בלבד       │ 250          │
│ מלווה 3         │ שיער בלבד        │ 200          │
└─────────────────────────────────────────────────────┘

סיכום פיננסי:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
סה"כ עלות השירותים:     2,800 ₪
מקדמה ששולמה:            1,000 ₪
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
יתרה לתשלום ביום האירוע: 1,800 ₪
```

---

## 💻 שינויים טכניים

### Schema Updates (MongoDB)
```javascript
// server-cloud.js - שורה 56
const leadSchema = new mongoose.Schema({
  lastName: { type: String, required: true },  // ✅ REQUIRED
  escortType: { 
    type: String, 
    default: 'none',     // 'none' | 'short' | 'long'
  },
  escortPrice: Number,
  bridesmaids: [{        // ❌ הוסרו: hasBridesmaids, bridesmaidsCount, bridesmaidsPrice
    service: String,
    price: Number
  }]
});
```

### JavaScript Functions (app_db.js)
```javascript
// StageManager - ניהול מודל מחיר
const StageManager = {
  handleStageChange(leadId, newStage),
  confirmPrice(),
  skipPrice()
};

// UI Helpers
window.toggleEscortPrice();          // הצג/הסתר שדה מחיר ליווי
window.updateBridesmaidsFields();    // צור שדות דינמיים למלוות
```

### Contract Generation (server-cloud.js)
```javascript
// חישוב מחיר כולל
let totalPrice = lead.price;

// הוסף ליווי
if (lead.escortType !== 'none') {
  totalPrice += lead.escortPrice;
}

// הוסף מלוות
const bridesmaidsTotal = lead.bridesmaids
  .reduce((sum, b) => sum + b.price, 0);
totalPrice += bridesmaidsTotal;
```

---

## 🔄 מיגרציה מגרסה 10.x

### אין צורך במיגרציה!
המערכת תומכת בלידים ישנים:
- לידים ישנים ללא `lastName` - עדיין יעבדו
- לידים ישנים עם `hasEscort`, `hasBridesmaids` - עדיין יעבדו
- רק לידים **חדשים** צריכים `lastName`

### המלצות
1. עדכן לידים פעילים עם שם משפחה
2. בעת יצירת חוזה חדש - השתמש במבנה החדש
3. הלידים הישנים יוצגו בחוזה לפי המבנה הישן

---

## 📱 בדיקת התכונות החדשות

### Test Case 1: יצירת ליד חדש
1. לחץ + בלוח
2. נסה לשמור בלי שם משפחה → ❌ שגיאה
3. הזן שם משפחה → ✅ עובד

### Test Case 2: מודל מחיר
1. צור ליד חדש בלי מחיר
2. העבר לעמודה "בטיפול"
3. מודל יופיע → הזן מחיר או דלג

### Test Case 3: ליווי
1. העבר ליד ל"חוזה נשלח"
2. בחר "ליווי קצר" → שדה מחיר מופיע
3. בחר "ללא ליווי" → שדה מחיר נעלם

### Test Case 4: מלוות
1. העבר ליד ל"חוזה נשלח"
2. בחר 3 מלוות
3. 3 שורות יופיעו
4. מלא שירות ומחיר לכל מלווה
5. צור חוזה → בדוק שהחוזה מכיל 3 שורות נפרדות

---

## 🐛 בעיות נפוצות ופתרונות

### שגיאה: "שם משפחה חסר"
**פתרון**: ודא שמילאת את שדה שם המשפחה לפני שמירה

### מודל מחיר לא מופיע
**פתרון**: הליד כבר יש לו מחיר. ערוך את הליד אם רוצה לשנות

### שדות מלוות לא מופיעים
**פתרון**: ודא שבחרת כמות מלוות גדולה מ-0

### החוזה לא מכיל מלוות
**פתרון**: ודא שמילאת גם שירות וגם מחיר לכל מלווה

---

## 📞 תמיכה
לשאלות או בעיות: פנה למפתח הראשי

**גרסה**: v11.0  
**תאריך עדכון**: 28.12.2024  
**commit**: 36ca2a4
