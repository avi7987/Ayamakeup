<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¢×¨×™×›×ª ×ª×‘× ×™×ª ×—×•×–×” - Luna</title>
    <meta name="description" content="Luna - Contract template editor">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .editor-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            color: #333;
        }
        .variables-panel {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            background: #f9fafb;
        }
        .editor-panel {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        #templateEditor {
            width: 100%;
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            resize: none;
            direction: ltr;
            text-align: left;
        }
        .variable-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .variable-item:hover {
            background: #e0e7ff;
            border-color: #818cf8;
        }
        .variable-name {
            font-family: 'Courier New', monospace;
            color: #4f46e5;
            font-weight: bold;
            font-size: 13px;
        }
        .variable-desc {
            font-size: 11px;
            color: #6b7280;
            margin-top: 3px;
        }
        .logo-preview {
            max-width: 200px;
            max-height: 100px;
            margin-top: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">ğŸ“ ×¢×¨×™×›×ª ×ª×‘× ×™×ª ×—×•×–×”</h1>
                    <p class="text-gray-600 mt-2">×¢×¨×•×š ××ª ×”×ª×‘× ×™×ª ×”×‘×¡×™×¡×™×ª ×œ×—×•×–×™× ×©×œ×š ×•×”×•×¡×£ ××©×ª× ×™× ×“×™× ××™×™×</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="previewContract()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-bold transition-all">
                        ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××”
                    </button>
                    <button onclick="saveTemplate()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-bold transition-all">
                        ğŸ’¾ ×©××•×¨ ×ª×‘× ×™×ª
                    </button>
                    <button onclick="window.location.href='/'" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-bold transition-all">
                        ğŸ  ×—×–×¨×” ×œ×¨××©×™
                    </button>
                </div>
            </div>
        </div>

        <!-- Logo Upload -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">ğŸ–¼ï¸ ×œ×•×’×•</h2>
            <div class="flex items-center gap-4">
                <input type="file" id="logoInput" accept="image/*" class="block w-64 text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50">
                <button onclick="uploadLogo()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-bold transition-all">
                    ğŸ“¤ ×”×¢×œ×” ×œ×•×’×•
                </button>
            </div>
            <div id="logoPreviewContainer" class="hidden mt-4">
                <p class="text-sm text-gray-600 mb-2">×œ×•×’×• × ×•×›×—×™:</p>
                <img id="logoPreview" src="" alt="×œ×•×’×•" class="logo-preview">
            </div>
        </div>

        <!-- Preview Modal -->
        <div id="previewModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closePreviewModal()">Ã—</button>
                <div id="previewContent"></div>
            </div>
        </div>

        <!-- Editor -->
        <div class="editor-container">
            <!-- Variables Panel -->
            <div class="variables-panel">
                <h3 class="font-bold text-lg mb-4">ğŸ“‹ ××©×ª× ×™× ×–××™× ×™×</h3>
                <p class="text-xs text-gray-600 mb-4">×œ×—×¥ ×¢×œ ××©×ª× ×” ×›×“×™ ×œ×”×¢×ª×™×§</p>
                
                <div class="space-y-2">
                    <!-- Basic Info -->
                    <div class="text-sm font-bold text-gray-700 mt-4 mb-2">×¤×¨×˜×™ ×œ×§×•×—:</div>
                    <div class="variable-item" onclick="insertVariable('{{fullName}}')">
                        <div class="variable-name">{{fullName}}</div>
                        <div class="variable-desc">×©× ××œ×</div>
                    </div>
                    <div class="variable-item" onclick="insertVariable('{{phone}}')">
                        <div class="variable-name">{{phone}}</div>
                        <div class="variable-desc">××¡×¤×¨ ×˜×œ×¤×•×Ÿ</div>
                    </div>
                    
                    <!-- Event Info -->
                    <div class="text-sm font-bold text-gray-700 mt-4 mb-2">×¤×¨×˜×™ ××™×¨×•×¢:</div>
                    <div class="variable-item" onclick="insertVariable('{{service}}')">
                        <div class="variable-name">{{service}}</div>
                        <div class="variable-desc">×¡×•×’ ×©×™×¨×•×ª</div>
                    </div>
                    <div class="variable-item" onclick="insertVariable('{{eventDate}}')">
                        <div class="variable-name">{{eventDate}}</div>
                        <div class="variable-desc">×ª××¨×™×š ××™×¨×•×¢</div>
                    </div>
                    <div class="variable-item" onclick="insertVariable('{{location}}')">
                        <div class="variable-name">{{location}}</div>
                        <div class="variable-desc">××™×§×•×</div>
                    </div>
                    
                    <!-- Financial -->
                    <div class="text-sm font-bold text-gray-700 mt-4 mb-2">×¤×™× × ×¡×™×:</div>
                    <div class="variable-item" onclick="insertVariable('{{proposedPrice}}')">
                        <div class="variable-name">{{proposedPrice}}</div>
                        <div class="variable-desc">××—×™×¨ ××•×¦×¢ ×œ×œ×§×•×—</div>
                    </div>
                    <div class="variable-item" onclick="insertVariable('{{totalPrice}}')">
                        <div class="variable-name">{{totalPrice}}</div>
                        <div class="variable-desc">××—×™×¨ ×›×•×œ×œ</div>
                    </div>
                    <div class="variable-item" onclick="insertVariable('{{price}}')">
                        <div class="variable-name">{{price}}</div>
                        <div class="variable-desc">××—×™×¨ ×¢×™×§×¨×™</div>
                    </div>
                    <div class="variable-item" onclick="insertVariable('{{deposit}}')">
                        <div class="variable-name">{{deposit}}</div>
                        <div class="variable-desc">××§×“××”</div>
                    </div>
                    <div class="variable-item" onclick="insertVariable('{{balance}}')">
                        <div class="variable-name">{{balance}}</div>
                        <div class="variable-desc">×™×ª×¨×”</div>
                    </div>
                    
                    <!-- Special -->
                    <div class="text-sm font-bold text-gray-700 mt-4 mb-2">××™×•×—×“×™×:</div>
                    <div class="variable-item" onclick="insertVariable('{{date}}')">
                        <div class="variable-name">{{date}}</div>
                        <div class="variable-desc">×ª××¨×™×š ×”×™×•×</div>
                    </div>
                    <div class="variable-item" onclick="insertVariable('{{servicesTable}}')">
                        <div class="variable-name">{{servicesTable}}</div>
                        <div class="variable-desc">×˜×‘×œ×ª ×©×™×¨×•×ª×™×</div>
                    </div>
                    <div class="variable-item" onclick="insertVariable('{{logoUrl}}')">
                        <div class="variable-name">{{logoUrl}}</div>
                        <div class="variable-desc">×›×ª×•×‘×ª ×œ×•×’×•</div>
                    </div>
                </div>
            </div>

            <!-- Editor Panel -->
            <div class="editor-panel">
                <h3 class="font-bold text-lg mb-4">âœï¸ ×¢×•×¨×š ×ª×‘× ×™×ª (HTML)</h3>
                <textarea id="templateEditor" placeholder="×”×§×œ×“ ×›××Ÿ ××ª ×ª×‘× ×™×ª ×”×—×•×–×”...&#10;&#10;××ª×” ×™×›×•×œ ×œ×”×©×ª××© ×‘-HTML ×œ×¢×™×¦×•×‘ ×•×‘××©×ª× ×™× ××”×¨×©×™××” ××©×××œ.&#10;&#10;×“×•×’××”:&#10;<h1>×—×•×–×”</h1>&#10;<p>×©× ×”×œ×§×•×—: {{fullName}}</p>"></textarea>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + '/api';
        let currentLogoUrl = '';

        // Load template on page load
        async function loadTemplate() {
            try {
                const response = await fetch(`${API_BASE_URL}/contract-template-html`);
                const data = await response.json();
                
                document.getElementById('templateEditor').value = data.templateHTML || '';
                currentLogoUrl = data.logoUrl || '';
                
                if (currentLogoUrl) {
                    document.getElementById('logoPreview').src = window.location.origin + currentLogoUrl;
                    document.getElementById('logoPreviewContainer').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading template:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª×‘× ×™×ª');
            }
        }

        // Insert variable at cursor position
        function insertVariable(variable) {
            const editor = document.getElementById('templateEditor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            
            editor.value = text.substring(0, start) + variable + text.substring(end);
            editor.selectionStart = editor.selectionEnd = start + variable.length;
            editor.focus();
            
            // Show notification
            const notification = document.createElement('div');
            notification.textContent = `×”×•×¡×¤×ª×™: ${variable}`;
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        // Save template
        async function saveTemplate() {
            const templateHTML = document.getElementById('templateEditor').value;
            
            if (!templateHTML.trim()) {
                alert('×”×ª×‘× ×™×ª ×¨×™×§×”! ×”×§×œ×“ ××©×”×• ×§×•×“×.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/contract-template-html`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ templateHTML })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… ×”×ª×‘× ×™×ª × ×©××¨×” ×‘×”×¦×œ×—×”!');
                } else {
                    throw new Error(data.error || '×©×’×™××” ×œ× ×™×“×•×¢×”');
                }
            } catch (error) {
                console.error('Error saving template:', error);
                alert('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×ª×‘× ×™×ª: ' + error.message);
            }
        }

        // Upload logo
        async function uploadLogo() {
            const fileInput = document.getElementById('logoInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('×‘×—×¨ ×§×•×‘×¥ ×ª××•× ×” ×§×•×“×');
                return;
            }
            
            const formData = new FormData();
            formData.append('logo', file);
            
            try {
                const response = await fetch(`${API_BASE_URL}/upload-logo`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentLogoUrl = data.logoUrl;
                    document.getElementById('logoPreview').src = window.location.origin + data.logoUrl;
                    document.getElementById('logoPreviewContainer').classList.remove('hidden');
                    alert('âœ… ×”×œ×•×’×• ×”×•×¢×œ×” ×‘×”×¦×œ×—×”!');
                } else {
                    throw new Error(data.error || '×©×’×™××” ×œ× ×™×“×•×¢×”');
                }
            } catch (error) {
                console.error('Error uploading logo:', error);
                alert('âŒ ×©×’×™××” ×‘×”×¢×œ××ª ×”×œ×•×’×•: ' + error.message);
            }
        }

        // Preview contract with sample data
        function previewContract() {
            const templateHTML = document.getElementById('templateEditor').value;
            
            // Sample data for preview
            const sampleData = {
                fullName: '×©×¨×” ×›×”×Ÿ',
                phone: '050-1234567',
                service: '××™×¤×•×¨ ×•×©×™×¢×¨ ×œ×›×œ×”',
                eventDate: '15.06.2024',
                location: '××•×œ××™ ×”×–×”×‘, ×ª×œ ××‘×™×‘',
                proposedPrice: '3,000',
                totalPrice: '3,500',
                price: '2,500',
                deposit: '1,000',
                balance: '2,500',
                date: new Date().toLocaleDateString('he-IL'),
                logoUrl: currentLogoUrl ? window.location.origin + currentLogoUrl : '',
                servicesTable: `
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr style="background-color: #f5f5f5;">
                                <th style="border: 1px solid #333; padding: 12px; text-align: center;">×ª×™××•×¨ ×”×©×™×¨×•×ª</th>
                                <th style="border: 1px solid #333; padding: 12px; text-align: center;">×¤×¨×˜×™×</th>
                                <th style="border: 1px solid #333; padding: 12px; text-align: center;">××—×™×¨ (â‚ª)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border: 1px solid #333; padding: 10px; text-align: right;">××™×¤×•×¨ ×•×©×™×¢×¨ ×œ×›×œ×”</td>
                                <td style="border: 1px solid #333; padding: 10px; text-align: center;">×©×™×¨×•×ª ×¢×™×§×¨×™</td>
                                <td style="border: 1px solid #333; padding: 10px; text-align: center;">2,500</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #333; padding: 10px; text-align: right;">×œ×™×•×•×™ ×œ××™×¨×•×¢</td>
                                <td style="border: 1px solid #333; padding: 10px; text-align: center;">×œ×™×•×•×™ ×§×¦×¨</td>
                                <td style="border: 1px solid #333; padding: 10px; text-align: center;">500</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #333; padding: 10px; text-align: right;">××œ×•×•×” 1</td>
                                <td style="border: 1px solid #333; padding: 10px; text-align: center;">××™×¤×•×¨ ×•×©×™×¢×¨</td>
                                <td style="border: 1px solid #333; padding: 10px; text-align: center;">500</td>
                            </tr>
                        </tbody>
                    </table>
                `
            };
            
            // Replace variables
            let preview = templateHTML;
            for (const [key, value] of Object.entries(sampleData)) {
                const regex = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
                preview = preview.replace(regex, value);
            }
            
            // Handle conditional logo
            if (currentLogoUrl) {
                preview = preview.replace(/\{\{#if logoUrl\}\}/g, '');
                preview = preview.replace(/\{\{\/if\}\}/g, '');
            } else {
                preview = preview.replace(/\{\{#if logoUrl\}\}[\s\S]*?\{\{\/if\}\}/g, '');
            }
            
            // Show in modal popup
            document.getElementById('previewContent').innerHTML = preview;
            document.getElementById('previewModal').classList.add('active');
        }
        
        function closePreviewModal() {
            document.getElementById('previewModal').classList.remove('active');
        }

        // Load template on page load
        loadTemplate();
    </script>
</body>
</html>
